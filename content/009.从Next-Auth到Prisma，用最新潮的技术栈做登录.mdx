---
title: ä»Next-Authåˆ°Prismaï¼Œç”¨æœ€æ–°æ½®çš„æŠ€æœ¯æ ˆåšç™»å½•
description: è®©æˆ‘ä»¬ç”¨å‰ç«¯å½“çº¢ç‚¸å­é¸¡NextJS+Next-Auth+Postgres+Prismaæ¥å®Œæˆç™»å½•æ¨¡å—ï¼Œå…¨æ–°çš„æŠ€æœ¯æ ˆå°†æå¤§ç®€åŒ–æˆ‘ä»¬çš„ç™»å½•æ¨¡å—å¼€å‘æµç¨‹ï¼Œä¸ä¿¡æ¥çœ‹çœ‹
slug: nextjs-auth-postgres-prisma-login
slugId: 061d8cd9-fcf3-4d9e-bd33-e257bc4f9989
tags: ç™»å½•,NextJSå®æˆ˜,NextJS,Backend
date: 2023-08-20
---

## å¼•è¨€

ä½¿ç”¨`React`æ¡†æ¶çš„å‰ç«¯å·¥ç¨‹å¸ˆåº”è¯¥éƒ½å¬è¿‡ä¸€å¥è¯ï¼š`React`çš„æˆå‘˜ä¸æ˜¯åœ¨`NextJS`å°±æ˜¯åœ¨å»`NextJS`çš„è·¯ä¸Šã€‚`NextJS`çš„æ ¸å¿ƒå›¢é˜Ÿå¤šæ¥è‡ª`React`ï¼Œè¿™æ­£æ˜¯`NextJS`å¿«é€Ÿæˆé•¿çš„åŸå› ä¹‹ä¸€ã€‚

é‚£ä¹ˆ`NextJS`æœ‰ä»€ä¹ˆç‰¹æ€§å‘¢ï¼Ÿ`NextJS`ä¸º`React`åº”ç”¨æä¾›äº†éå¸¸ä¾¿åˆ©çš„å¼€ç®±å³ç”¨åŠŸèƒ½ï¼Œå¦‚è·¯ç”±ã€é¡µé¢é¢„è·å–ã€æœåŠ¡å™¨ç«¯æ¸²æŸ“ç­‰ï¼Œæå¤§åœ°ç®€åŒ–å’ŒåŠ é€Ÿäº†å¼€å‘ï¼Œè¿™ä¹Ÿè®©`NextJS`æˆä¸ºå‰ç«¯é¢†åŸŸçš„å½“çº¢ç‚¸å­é¸¡ã€‚

`NextJS`èƒŒåçš„å…¬å¸æ˜¯`Vercel`ï¼Œè¿™å®¶å…¬å¸è¿˜æœ‰å½“å‰æœ€çƒ­é—¨çš„è‡ªåŠ¨åŒ–éƒ¨ç½²äº‘å¹³å°`Vercel`ã€‚

åœ¨`NextJS`ç¤¾åŒºé‡Œï¼Œè¿˜æœ‰ä¸‹ä¸€ä»£`Node.js`å’Œ`TypeScript`çš„`ORM`â€”â€”`Prisma`ï¼›è¿˜æœ‰è‹±å›½å¼€å‘è€…Iain Collinså¼€å‘äº†`next-auth`ï¼Œè¿™æ˜¯ä¸€ä¸ªæ”¯æŒå¤šç§ç™»å½•æ–¹å¼å¦‚ `OAuthã€emailã€credentials`çš„åº“ï¼Œèƒ½å¤Ÿæå¤§ç®€åŒ–æˆ‘ä»¬å¼€å‘ç™»å½•åŠŸèƒ½çš„æ—¶é—´ã€‚

`NextJS + Next-Auth + Prisma`ï¼Œéšç€ä¸‰ä¸ªä¸»è§’æ‚‰æ•°äº®ç›¸ï¼Œå°±å¯ä»¥æ˜ç¡®æœ¬æ–‡çš„ç›®æ ‡äº†ï¼šç”¨`NextJSã€Next-Authã€Prisma`æ¥å®Œæˆä¸€ä¸ª`Github OAuth`ç™»å½•çš„åŠŸèƒ½ã€‚

**çœ‹å®Œæœ¬æ–‡ä½ å°†å­¦åˆ°ï¼š**

- åˆ›å»ºä½ çš„`Github`åº”ç”¨
- åœ¨`NextJS`é¡¹ç›®ä¸­ä½¿ç”¨`next-auth`å®Œæˆç™»å½•æµç¨‹ï¼ˆä¸é™äº`github`ç™»å½•ï¼‰
- `docker`æ„å»ºå¼€å‘ç¯å¢ƒ`postgres`æ•°æ®åº“
- å½“å‰æœ€çƒ­é—¨çš„`orm`â€”â€”`prisma`çš„åŸºæœ¬ä½¿ç”¨

## åˆ›å»ºGithubåº”ç”¨

æœ¬æ–‡å‡å®šä½ å¯¹`OAuth`æœ‰åŸºæœ¬çš„äº†è§£ï¼Œå¦‚æœä½ è¿˜ä¸äº†è§£ï¼Œæ‰¾ä¸ªå¯ä»¥æ‰«ç ç™»å½•`WeChat`çš„ç½‘ç«™ä½“éªŒä¸€ä¸‹ï¼Œé‚£å°±å«`OAuth`æˆæƒç™»å½•ã€‚

ç°åœ¨æˆ‘ä»¬åœ¨è‡ªå·±çš„`Github`åå°åˆ›å»ºä¸€ä¸ªåº”ç”¨ï¼Œç”¨æˆ·é€šè¿‡`OAuth`æˆæƒç™»å½•ï¼Œé‚£å°±æˆä¸ºä½ è¿™ä¸ªåº”ç”¨çš„ç”¨æˆ·å•¦ã€‚

ç¬¬ä¸€æ­¥ï¼šåˆ° [https://github.com/settings/apps](https://github.com/settings/apps) åˆ›å»º`OAuth`åº”ç”¨

ç¬¬äºŒæ­¥ï¼šå¡«å†™åº”ç”¨ä¿¡æ¯

![github oauth register.png](/assets/009/01github_oauth_register.png)

æ³¨æ„ï¼š`Authorization callback URL`æ˜¯æˆæƒç™»å½•åçš„å›è°ƒåœ°å€ï¼Œå¦‚æœç™»å½•æµç¨‹æ˜¯è‡ªå·±å¼€å‘ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±ä»£ç æ¥å¡«ï¼Œä½†æ˜¯æœ¬æ–‡æ˜¯ç”¨`next-auth`ï¼Œæ‰€ä»¥å¾—æŒ‰`next-auth`çš„è§„èŒƒæ¥åšï¼Œå¿…é¡»å¡«`/api/auth/callback/github`

ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºå®Œæˆåï¼Œä¼šè¿›å…¥åº”ç”¨åå°ï¼Œæ­¤æ—¶éœ€è¦ç”Ÿæˆ**Client**å’Œ**secrets**ï¼Œå¹¶ä¿å­˜ä¸‹**Client ID**å’Œ**Client secrets**ã€‚

![github oauth register2.png](/assets/009/02github_oauth_register2.png)

å› ä¸ºç°åœ¨è¿˜å¤„äºæœ¬åœ°è°ƒè¯•é˜¶æ®µï¼Œæ‰€ä»¥æˆ‘æŠŠè®¾ç½®çš„ä¸¤ä¸ªURLæ”¹æˆ`localhost`äº†ï¼š

![github oauth register3.png](/assets/009/03github_oauth_register3.png)

`Github`åº”ç”¨åˆ›å»ºå°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œå¾ˆé€‚åˆç”¨æ¥åšä¸€äº›å®éªŒæ€§çš„åŠŸèƒ½ã€‚

æ‰©å±•é˜…è¯»ï¼š

å¦‚æœæƒ³å­¦ä¹ `Google`çš„`OAuth`ï¼Œè¯·çŒ›çƒˆç‚¹å‡»æˆ‘çš„å†å²æ–‡ç« ï¼š

[è°·æ­ŒOAuth2.0å¼€å‘çš„æ­£ç¡®é…ç½®æ­¥éª¤](/article/integrate-google-oauth2-1)

## ç”¨Next-Authå®ç°ç™»å½•

å…ˆåˆ›å»ºä¸€ä¸ª`Next`é¡¹ç›®ï¼š

```bash
npx create-next-app@latest
```

å®‰è£…`next-auth`

```bash
yarn add next-auth
```

åœ¨`nextjs v13.2`æ¨å‡ºåï¼Œ`next-auth`å·²æ”¯æŒ`app router`æ¨¡å¼ä¸‹åœ¨`app`æ–‡ä»¶å¤¹å†…æ„å»º`API`ï¼Œä½†æ˜¯é‰´äºå®˜æ–¹æ–‡æ¡£ä¸»è¦ä½¿ç”¨æ–¹å¼ä»ç„¶æ˜¯æ”¾åœ¨`pages`æ–‡ä»¶å¤¹ä¸‹ï¼Œæ‰€ä»¥æœ¬ä¾‹ä¹Ÿå°†åœ¨`pages`ä¸‹è¿›è¡Œ`API`ç¼–å†™ã€‚

åœ¨`pages/api/auth`ä¸­åˆ›å»ºä¸€ä¸ªåä¸º`[...nextauth].ts`çš„æ–‡ä»¶

```tsx
import NextAuth from "next-auth"

import { authOptions } from "@/lib/auth"

// @see ./lib/auth
export default NextAuth(authOptions)
```

`pages/api/auth/[...nextauth].ts`ä¸­ä½¿ç”¨`[...nextauth]`æ˜¯ä¸ºäº†åŠ¨æ€åŒ¹é…`nextauth`çš„æ‰€æœ‰APIè·¯ç”±ï¼Œå¦‚:

- `/api/auth/callback` å¤„ç†è®¤è¯å›è°ƒ
- `/api/auth/signin` å¤„ç†ç™»å½•
- `/api/auth/signout` å¤„ç†ç™»å‡º
- `/api/auth/session` è·å–`session`ç­‰ç­‰

ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨`[...nextauth]`å¯ä»¥åŠ¨æ€åŒ¹é…æ‰€æœ‰åŒ…å«`/api/auth/`å’Œ`nextauth`çš„`API`è·¯ç”±ã€‚

æˆ‘ä»¬æŠŠ`next-auth`çš„åŸºæœ¬é…ç½®æ”¾åœ¨äº†`lib/auth.ts`é‡Œï¼š

```tsx
import NextAuth, { NextAuthOptions } from "next-auth"
import GithubProvider from 'next-auth/providers/github';

export const authOptions: NextAuthOptions = {
  session: {
    strategy: "jwt",
  },
  pages: {
    signIn: "/auth/login",
    signOut: '/auth/logout',
  },
  providers: [
    GithubProvider({
      clientId: `${process.env.GITHUB_ID}`,
      clientSecret: `${process.env.GITHUB_SECRET}`,
      httpOptions: {
        timeout: 50000,
      },
    }),
    // GoogleProvider({
    //   clientId: process.env.GOOGLE_ID,
    //   clientSecret: process.env.GOOGLE_SECRET
    // }),
  ],
  callbacks: {
    session: async ({ session, token }) => {
      return token
    }
  },
}

export default NextAuth(authOptions)
```

`next-auth`çš„æœåŠ¡ç«¯å†…å®¹å°±æ˜¯è¿™äº›ï¼Œä¹ä¸€çœ‹å®¹æ˜“ä¸€å¤´é›¾æ°´ï¼Œä½†ç¡®å®å°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œå®ƒæŠŠä¸­é—´ç¹ççš„è¿‡ç¨‹éƒ½å°è£…èµ·æ¥äº†ã€‚

ç°åœ¨æ¥å†™ä¸ªè¿™æ ·çš„ç™»å½•é¡µ

![github oauth button.png](/assets/009/04github_oauth_button.png)

æ ¸å¿ƒä»£ç æ˜¯ã€Œä½¿ç”¨Githubç™»å½•ã€çš„æŒ‰é’®

```tsx
// components/UserAuthForm.tsx

"use client";

import * as React from "react";
import { signIn } from "next-auth/react";

import { cn } from "@/lib/utils";
import { buttonVariants } from "@/components/ui/button";
import { Icons } from "@/components/Icons";

interface UserAuthFormProps extends React.HTMLAttributes<HTMLDivElement> {}

export function UserAuthForm({ className, ...props }: UserAuthFormProps) {
  const [isGitHubLoading, setIsGitHubLoading] = React.useState<boolean>(false);

  const login = async () => {
    setIsGitHubLoading(true);
    signIn("github", { // ç™»å½•æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ ‡æ³¨å¹³å°
      callbackUrl: `${window.location.origin}`, // è®¾ç½®ç™»å½•æˆåŠŸåçš„å›è°ƒåœ°å€
    });
  };

  return (
    <div className={cn("grid gap-6", className)} {...props}>
      <button
        type="button"
        className={cn(buttonVariants())}
        onClick={login}
        disabled={isGitHubLoading}
      >
        {isGitHubLoading ? (
          <Icons.spinner className="mr-2 h-4 w-4 animate-spin" />
        ) : (
          <Icons.gitHub className="mr-2 h-4 w-4" />
        )}{" "}
        Github
      </button>
    </div>
  );
}
```

å‰ç«¯éƒ¨åˆ†ä¹Ÿå®Œæˆäº†ã€‚

è¿™æ—¶å€™è¿˜è¦é…ä¸€ä¸ªç¯å¢ƒå˜é‡

```bash
# .env
GITHUB_ID=YOUR_GITHUB_ID
GITHUB_SECRET=YOUR_GITHUB_SECRET

# NEXTAUTH_SECRETæ˜¯å¿…å¡«é¡¹ï¼Œç”¨å‘½ä»¤ç”Ÿæˆ: openssl rand -base64 32
NEXTAUTH_SECRET=YOUR_NEXTAUTH_SECRET
NEXTAUTH_URL=http://localhost:3001 # å‘Šè¯‰next-authæˆæƒå›è°ƒçš„åŸºç¡€ URLï¼Œè¿™ä¸ªç¯å¢ƒå˜é‡æ˜¯å¿…é¡»çš„ï¼Œè™½ç„¶å®ƒæ²¡æœ‰åœ¨æˆ‘ä»¬çš„ä»£ç é‡Œä½“ç°
```

ç°åœ¨è¯•ä¸€ä¸‹èƒ½ä¸èƒ½å®Œæˆ`Github OAuth`ç™»å½•ã€‚ç‚¹å‡»æŒ‰é’®ç¡®å®ä¼šè·³åˆ°æˆæƒé¡µ

![github oauth page.png](/assets/009/05github_oauth_page.png)

æˆæƒåä¼šè·³åˆ°é¦–é¡µï¼Œå®Œæˆäº†æˆæƒç™»å½•æµç¨‹äº†ã€‚

éœ€è¦ä¸€ä¸ªæ›´å‡†ç¡®çš„ä¿¡æ¯è¯æ˜çœŸçš„å®Œæˆæˆæƒç™»å½•äº†ï¼Ÿé‚£å°±åœ¨é¦–é¡µæŠŠä¸ªäººä¿¡æ¯å›æ˜¾å‡ºæ¥ã€‚è¿™ä¾ç„¶éœ€è¦ç”¨åˆ°`next-auth`çš„`api`ã€‚è®©æˆ‘ä»¬åœ¨`lib`ä¸‹é¢æ–°å»ºä¸€ä¸ªæ–‡ä»¶å«åš`session.ts`

```tsx
// session.ts
import { getServerSession } from "next-auth/next"

import { authOptions } from "@/lib/auth"

export async function getCurrentUser() {
  const session = await getServerSession(authOptions)

  return session?.user
}
```

åœ¨`app/page.tsx`è°ƒç”¨

```tsx
import Image from 'next/image'
import { getCurrentUser } from "@/lib/session";

export default async function Home() {
  const user = await getCurrentUser();
  console.log(user);

	return (
		<main>
			â€¦â€¦<div>
        <div className="flex">
          {user?.image ? (
            <>
              {" "}
              Current User:{" "}
              <Image
                className="relative rounded-full ml-3 dark:drop-shadow-[0_0_0.3rem_#ffffff70] dark:invert"
                src={user.image}
                alt="Next.js Logo"
                width={36}
                height={36}
                priority
              />
            </>
          ) : (
            <></>
          )}
        </div>
        {!user ? (
          <div className="">
            Next-Authçš„demoè¯·åˆ°
            <Link
              href="/login"
              className="hover:text-brand underline underline-offset-4"
            >
              ç™»å½•é¡µ
            </Link>
            ä½“éªŒ
          </div>
        ) : (
          <SignOut></SignOut>
        )}
      </div>
			â€¦â€¦
		</main>
	)
}
```

ä¸ºäº†`Image`å¯ä»¥ç”Ÿæ•ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨`next.config.js`é‡Œæ·»åŠ å¯ä¿¡åŸŸ

```tsx
/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    domains: ['avatars.githubusercontent.com'], // æ·»åŠ githubå¤´åƒæœåŠ¡çš„åŸŸå
  },
}

module.exports = nextConfig
```

ç°åœ¨åœ¨é¦–é¡µå°±å¯ä»¥çœ‹åˆ°ç”¨æˆ·ä¿¡æ¯å›æ˜¾äº†

![6ã€github oauth success.png](/assets/009/06github_oauth_success.png)

å¦‚æœä½ è‡ªå·±å¼€å‘è¿‡`oauth`ç™»å½•ï¼Œå†çœ‹åˆ°`next-auth`çš„æµç¨‹ï¼Œä½ ä¸€å®šä¼šå¾ˆå…´å¥‹ï¼Œå› ä¸º`next-auth`å¸®æˆ‘ä»¬å¤„ç†æ‰äº†å¾ˆå¤šä¸­é—´è¿‡ç¨‹ã€‚å¦‚æœä½ æ²¡å¼€å‘è¿‡`oauth`ï¼Œå¯ä»¥åˆ°è¿™ä¸€ç¯‡çœ‹çœ‹è‡ªå·±å¼€å‘`oauth`ç™»å½•æœ‰å¤šéº»çƒ¦ï¼š[æ¥å…¥è°·æ­ŒOAuth2.0ç™»å½•çš„åˆ†æå’Œä»£ç å®è·µ](/article/integrate-google-oauth2-2)

## æ­å»ºpostgresæµ‹è¯•æ•°æ®åº“

æœ‰æ—¶å€™æˆ‘ä»¬ä¸æ­¢æ˜¯éœ€è¦ç¬¬ä¸‰æ–¹æˆæƒçš„ç”¨æˆ·ä¿¡æ¯ï¼Œæˆ‘ä»¬è¿˜æƒ³è‡ªå·±ä¿å­˜ä¸€ä¸ªç”¨æˆ·è¡¨ï¼ŒæŠŠç”¨æˆ·åŸºæœ¬ä¿¡æ¯å’Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ä¸€äº›å­—æ®µå…±å­˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦å»ºä¸€ä¸ªæ•°æ®åº“äº†ã€‚

åœ¨`Mysql`è¢«`oracle`æ”¶è´­åï¼Œ`postgres`æˆä¸ºå¼€æºç¤¾åŒºé‡Œæœ€é—ªäº®çš„æ–°æ˜Ÿã€‚`postgres`ä¹Ÿæ˜¯æœ¬æ–‡ä»£ç ç”¨åˆ°çš„æ•°æ®åº“ã€‚

å¦‚æœæˆ‘ä»¬è‡ªå·±å®‰è£…`postgres`ï¼Œå¾ˆå¤šæ“ä½œä¼šæ˜¾å¾—éå¸¸ç¹çï¼Œä½†å¦‚æœåœ¨`docker`ä¸­å®‰è£…ï¼Œä¸€åˆ‡å°±å˜å¾—éå¸¸ä¸æ»‘ã€‚

å¦‚æœä½ è¿˜æ²¡å®‰è£…`docker`ï¼Œè¯·é€šè¿‡å®˜ç½‘å®‰è£…ä¸€ä¸‹ï¼Œå®‰è£…åç”¨å‘½ä»¤éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸï¼Œå¦‚æœå®‰è£…æˆåŠŸï¼Œä¼šè¿”å›`docker`çš„ç‰ˆæœ¬å·ã€‚

```bash
docker-compose -v
```

dockerå®‰è£…å®Œæˆåï¼Œåˆ°é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶`docker-compose.yml`

```yaml
# docker-compose.yml
version: '3.1'
services:
  nextjs-learn-domes:
    image: postgres
    volumes:
      - ./postgres:/var/lib/postgresql/data
    ports:
      - 5432:5432
    environment:
      - POSTGRES_USER=myuser
      - POSTGRES_PASSWORD=mypassword

  adminer:
    image: adminer
    restart: always
    ports:
      - 8080:8080
```

å¯åŠ¨`docker`

```bash
docker-compose up -d
```

å¦‚æœå¯åŠ¨å¤±è´¥ï¼Œè¯·æ’æŸ¥5432å’Œ8080ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼Œå¦‚æœè¢«å ç”¨éœ€è¦å…ˆå…³é—­å ç”¨çš„æœåŠ¡å†å¯åŠ¨`docker`ã€‚

ç°åœ¨è®¿é—®`http://localhost:8080`å°±å¯ä»¥ç™»å½•æ•°æ®åº“äº†

![7ã€db login.png](/assets/009/07db_login.png)

å¦‚æœè¦å…³é—­`docker`ï¼Œå¯ä»¥æ‰§è¡Œå‘½ä»¤

```bash
docker-compose down
```

**å¦‚æœä½ æƒ³å­¦ä¹ `Docker`çš„åŸºæœ¬çŸ¥è¯†ï¼Œè¯·é˜…è¯»æ–‡ç« **ï¼š[å‰ç«¯æœ‰äº†Dockerï¼Œå…¨æ ˆä¹‹è·¯æ›´è½»æ¾äº†](/article/docker-full-stack)

## ç”¨Prismaæ“ä½œæ•°æ®åº“

Prismaæ˜¯ä¸‹ä¸€ä»£`Node.js`å’Œ`TypeScript`çš„`ORM`ã€‚åœ¨Nodeä¸­ç”¨è¿‡`Sequelize`æ“ä½œæ•°æ®åº“çš„å…„å¼Ÿéƒ½çŸ¥é“ï¼Œè¿™æ˜¯ä¸€ä¸ªè®©ä½ å¯ä»¥ç”¨å†™å¯¹è±¡çš„æ–¹å¼æ¥å†™`sql`çš„å·¥å…·ï¼Œæå¤§ç®€åŒ–äº†å‰ç«¯å¯¹`sql`çš„å­¦ä¹ æˆæœ¬å’Œå¼€å‘æˆæœ¬ï¼Œ`Prisma`ä¹Ÿæ˜¯è¿™æ ·çš„å·¥å…·ã€‚

> è¿™é‡Œæœ‰å¯¹`Prisma`å’Œ`Sequelize`çš„ç®€å•ä¼˜åŠ¿å¯¹æ¯”ï¼š
> 
> 1. `Prisma`æ‹¥æœ‰è‡ªå·±çš„æŸ¥è¯¢è¯­è¨€`Prisma Query Language(PQL)`,è¯­æ³•æ›´æ¥è¿‘SQL,ä¸Šæ‰‹æ›´ç®€å•ã€‚`Sequelize`ä½¿ç”¨çš„æ˜¯JSè¯­æ³•,éœ€è¦å­¦ä¹ æ›´å¤šAPIã€‚
> 2. `Prisma`æœ‰è‡ªåŠ¨ç”Ÿæˆå¹¶æ›´æ–°æ•°æ®åº“`Schema`çš„åŠŸèƒ½,å¯ä»¥é€šè¿‡`Prisma Client`ç›´æ¥è®¿é—®æ•°æ®åº“,æ›´ç¬¦åˆç°ä»£å¼€å‘æ–¹å¼ã€‚`Sequelize`éœ€è¦æ›´å¤šæ‰‹åŠ¨é…ç½®ã€‚
> 3. `Prisma`åŸºäºä¸‹ä¸€ä»£`ORM`ç†å¿µ,å¦‚æ— ç¼çš„å…³ç³»æ˜ å°„ã€ç±»å‹å®‰å…¨ç­‰ç‰¹æ€§ã€‚`Sequelize`ç›¸å¯¹æ›´ä¼ ç»Ÿã€‚
> 4. `Prisma`æœ‰æ›´å¥½çš„`TypeScript`æ”¯æŒ,æä¾›è‰¯å¥½çš„ç±»å‹æ¨å¯¼ã€‚`Sequelize`çš„`TypeScript`ä½“éªŒè¾ƒå·®ã€‚
> 5. `Prisma`æœ‰ç›´è§‚çš„æ•°æ®æ¨¡å‹å¯è§†åŒ–åŠŸèƒ½ã€‚`Sequelize`éœ€è¦é€šè¿‡ä»£ç ç†è§£æ•°æ®ç»“æ„ã€‚
> 6. `Sequelize`ç¤¾åŒºæ›´åŠ æˆç†Ÿ,èµ„æºæ›´ä¸°å¯Œã€‚`Prisma`ä½œä¸ºè¾ƒæ–°æ¡†æ¶,èµ„æºç›¸å¯¹è¾ƒå°‘ã€‚

å¼€å§‹ä½¿ç”¨Prisma

```bash
yarn add prisma @prisma/client
```

åˆå§‹åŒ–Prisma

```bash
npx prisma init
```

åˆå§‹åŒ–åï¼Œåœ¨æ ¹ç›®å½•ä¼šå‡ºç°ä¸€ä¸ª`prisma`çš„æ–‡ä»¶å¤¹ï¼Œè¿™ä¸ªæ–‡ä»¶å¤¹ç”¨æ¥å­˜æ”¾`Prisma`ç›¸å…³é…ç½®ï¼›é‡Œé¢è¿˜æœ‰ä¸€ä¸ª`schema.prisma`æ–‡ä»¶ï¼Œæ˜¯æ ¸å¿ƒçš„æ•°æ®åº“`Schema`å®šä¹‰æ–‡ä»¶ï¼Œå¼€å‘æ—¶ä¸»è¦é€šè¿‡ä¿®æ”¹å®ƒæ¥æ›´æ–°æ•°æ®åº“æ¨¡å‹è®¾è®¡ã€‚

å†å»çœ‹.envæ–‡ä»¶ï¼Œä¼šå‘ç°å¤šäº†ä¸€æ¡é…ç½®

```bash
DATABASE_URL="postgresql://johndoe:randompassword@localhost:5432/mydb?schema=public"
```

éœ€è¦æ”¹æˆæˆ‘ä»¬çš„postgresé…ç½®

```bash
DATABASE_URL="postgresql://myuser:mypassword@localhost:5432/mydb?schema=public"
```

### åˆ›å»ºæ•°æ®åº“

ç°åœ¨å¼€å§‹æ€è€ƒæˆ‘ä»¬çš„ç”¨æˆ·è¡¨ç»“æ„ï¼Œæœªæ¥æˆ‘ä»¬å¸Œæœ›é€šè¿‡`next-auth`æ¥å…¥å¤šä¸ªç¬¬ä¸‰æ–¹å¹³å°çš„`OAuth`ï¼Œé‚£ä¹ˆå¯ä»¥è®°å½•ä¸‹ç”¨æˆ·åœ¨ç¬¬ä¸‰æ–¹å¹³å°çš„å”¯ä¸€idï¼Œè¿˜éœ€è¦æŠ¹å¹³ä¸åŒå¹³å°çš„ç”¨æˆ·ä¿¡æ¯å­—æ®µã€‚é‚£ä¹ˆå°±å¯ä»¥åœ¨ç”¨æˆ·è¡¨é‡Œæ·»åŠ `sub`å’Œ`platform`ï¼Œå†ç»Ÿä¸€ç”¨æˆ·ä¿¡æ¯å­—æ®µ`username`ã€`avatar`ã€‚

`schema.prisma`æ˜¯å”¯ä¸€çš„`Schema`å®šä¹‰æ–‡ä»¶ï¼Œå®šä¹‰`User`è¡¨ç»“æ„å¦‚ä¸‹ï¼š

```scheme
// schema.prisma

â€¦â€¦

model User {
  id        Int      @id @default(autoincrement())
  sub       String   @unique // ç¬¬ä¸‰æ–¹å¹³å°çš„å”¯ä¸€id
  platform  String   // ç¬¬ä¸‰æ–¹å¹³å°æ ‡è¯†ï¼Œå¦‚ï¼šgithub google
  username  String
  avatar    String
  email     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

å®šä¹‰äº†è¡¨ç»“æ„åï¼Œæœ¬èº«ä¸ä¼šè‡ªåŠ¨åˆ›å»ºè¡¨ï¼Œéœ€è¦æ‰§è¡Œ`migrate`å‘½ä»¤æ‰ä¼šç”±`Prisma`æ¥ç”Ÿæˆå’Œæ‰§è¡Œåˆ›å»ºè¡¨çš„SQLè¯­å¥

```bash
npx prisma migrate dev --name "init"
```

æ‰“å¼€æ•°æ®åº“ï¼Œä¼šå‘ç°ç°åœ¨`User`è¡¨å·²ç»åˆ›å»ºå‡ºæ¥äº†

![8ã€db generate success.png](/assets/009/08db_generate_success.png)

å¦‚æœä½ æƒ³æ·±å…¥äº†è§£ä¸€ä¸‹`prisma migrate`å‘½ä»¤ï¼Œè¯·çŒ›çƒˆç‚¹å‡»ï¼š[prisma migrateå‘½ä»¤ç®€æ˜æ•™ç¨‹](/article/learn-prisma-migrate)

### å®ä¾‹åŒ–PrismaClient

åˆ›å»º`lib/prisma.ts`ï¼Œå®ä¾‹åŒ–`PrismaClient`

```tsx
import { PrismaClient } from "@prisma/client";

declare global {
  // eslint-disable-next-line no-var
  var prisma: PrismaClient
}

let prisma: PrismaClient;

if (process.env.NODE_ENV === "production") {
  prisma = new PrismaClient();
} else {
  if (!global.prisma) {
    global.prisma = new PrismaClient();
  }
  prisma = global.prisma;
}
export default prisma;
```

`PrismaClient`å®ä¾‹çš„ä½œç”¨æ˜¯è¿æ¥æ•°æ®åº“å¹¶æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼Œå¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªæ•°æ®åº“å®¢æˆ·ç«¯,å¯ä»¥é€šè¿‡å®ƒæ¥å‘é€æ•°æ®åº“æŸ¥è¯¢ã€ä¿®æ”¹æ•°æ®ã€‚

ä¿®æ”¹`auth/ts`ï¼Œæˆ‘ä»¬å°è¯•æŠŠä»`Github`è·å–çš„ç”¨æˆ·ä¿¡æ¯å­˜åˆ°`User`è¡¨é‡Œ

```tsx
â€¦â€¦
import prisma from "@/lib/prisma";
import { UserInfo } from "@/types/user";

â€¦â€¦

callbacks: {
    session: async ({ session, token }) => {
      const res = await prisma.user.upsert({
        where: {
          sub: token.sub
        },
        update: {
          // ä½¿ç”¨tokenä¸­çš„æ•°æ®
          username: token.name,
          avatar: token.picture,
          email: token.email
        },
        create: {
          // ä½¿ç”¨tokenä¸­çš„æ•°æ® 
          sub: token.sub,
          username: token.name,
          avatar: token.picture,
          email: token.email,
          platform: 'github',
        }
      })
      if (res) {
        session.user = {
          sub: res.sub,
          platform: res.platform,
          username: res.username,
          avatar: res.avatar,
          email: res.email,
        } as UserInfo
      }
      return session
    }
  },

â€¦â€¦

```

å›åˆ°é¡µé¢ï¼Œé‡æ–°ç™»å½•ä¸€ä¸‹ï¼Œä¼šå‘ç°åŸæœ¬æ˜¾ç¤ºå¤´åƒçš„ä½ç½®ä¸æ˜¾ç¤ºäº†ï¼Œè¯´æ˜å·²ç»æ‹¿åˆ°æˆ‘ä»¬å°è£…åçš„ç”¨æˆ·ä¿¡æ¯äº†ï¼Œåªè¦ä¿®æ”¹ä¸€ä¸‹å­—æ®µå°±å¯ä»¥å›æ˜¾ã€‚

## ç»“è¯­

é€šè¿‡æœ¬æ–‡çš„å­¦ä¹ ï¼Œæˆ‘ä»¬ç”¨å…¨æ–°çš„æŠ€æœ¯æ ˆ`NextJS+Next-Auth+Postgres+Prisma`å®Œæˆäº†ä¸€ä¸ªç™»å½•æ¨¡å—ï¼Œå¦‚æœä½ è‡ªå·±æŠ˜è…¾è¿‡ç™»å½•æµç¨‹ï¼Œä¸€å®šèƒ½æ„Ÿå—åˆ°`Next-Auth`çš„å¼ºå¤§ã€‚

æœ¬æ–‡æ¶‰åŠçš„æŠ€æœ¯æ ˆï¼Œéƒ½æ˜¯å½“å‰æµ·å¤–å‰ç«¯åœˆæµè¡Œçš„æ–°æŠ€æœ¯ï¼Œæ¯”è¾ƒé€‚åˆä¸ªäººå¼€å‘è€…å¿«é€Ÿå¼€å‘åˆ›æ„åŸå‹æˆ–å®ç”¨å·¥å…·ã€‚è¿™å¥—æŠ€æœ¯ç»„åˆbothå‰åç«¯éƒ½èƒ½å¿«é€Ÿé«˜æ•ˆåœ°å·¥ä½œï¼Œæ˜¯æ„å»ºwebåº”ç”¨çš„ç»ä½³é€‰æ‹©ã€‚

## æºç ä¸æ¼”ç¤º

æºç ï¼šğŸ‘‰[NextAuth-Prisma](https://github.com/weijunext/nextjs-learn-demos/tree/NextAuth-Prisma)

åœ¨çº¿æ¼”ç¤ºï¼šğŸ‘‰[NextAuthç™»å½•](https://nextjs.weijunext.com/)

## ä¸“æ èµ„æº

ä¸“æ ä»‹ç»ï¼šä»¥å®æˆ˜çš„è§’åº¦è¿›è¡ŒNext.jsç”Ÿæ€åœˆçš„æŠ€æœ¯æ ˆåˆ†äº«ï¼Œå†…å®¹åŒ…æ‹¬ä½†ä¸é™äºï¼šNext.jsç†è®ºçŸ¥è¯†ã€åŠŸèƒ½æ¨¡å—è®¾è®¡æ€è·¯ã€å®æˆ˜ä¸­ä½¿ç”¨åˆ°çš„æŠ€æœ¯æ ˆã€‚è¿™æ˜¯ä¸€ä¸ªé•¿æœŸæ›´æ–°çš„ä¸“æ ï¼Œæˆ‘ä¼šæŒç»­æŠŠè‡ªå·±çš„æ€è€ƒå’Œç»éªŒæç‚¼åˆ†äº«å‡ºæ¥ï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„ä¸“æ ğŸ‘‡

ä¸“æ åœ°å€ï¼šğŸ‘‰[Next.jsç”Ÿæ€åœˆå®æˆ˜](/tag/NextJS%E5%AE%9E%E6%88%98)

ä¸“æ æ¼”ç¤ºç«™ï¼šğŸ‘‰[Next.js Demos](https://nextjs.weijunext.com)

ä¸“æ æºç ä»“åº“ï¼šğŸ‘‰[Github - Source Code](https://github.com/weijunext/nextjs-learn-demos)

äº¤ä¸ªæœ‹å‹ï¼šğŸ‘‰[åŠ å…¥ã€Œç‹¬ç«‹å…¨æ ˆäº¤æµç¾¤ã€](/make-a-friend)