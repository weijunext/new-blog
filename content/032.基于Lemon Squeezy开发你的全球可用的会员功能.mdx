---
title: åŸºäºLemon Squeezyå¼€å‘ä½ çš„å…¨çƒå¯ç”¨çš„ä¼šå‘˜åŠŸèƒ½
description: ä¹¦æ¥ä¸Šå›ï¼Œæœ¬æ–‡ä»‹ç»äº†åŸºäºLemon Squeezyæ€ä¹ˆå¼€å‘ä½ çš„ä¼šå‘˜ç³»ç»Ÿ
slug: integrate-lemonsqueezy-api
tags: NextJS,NextJSå®æˆ˜
date: 2023-10-30
---

ã€Œä¼šå‘˜åŠŸèƒ½ç³»åˆ—æ–‡ç« ã€ç¬¬ä¸€ç¯‡ä¸­ã€Š[ğŸ‘‰å¸¦ä½ è®¾è®¡ä¸€å¥—ä¼šå‘˜åŠŸèƒ½å¹¶å¼€å‘å®ƒ](/article/build-membership-feature)ã€‹ï¼Œæˆ‘ä»¬æ¢³ç†äº†è´­ä¹°ä¼šå‘˜å‰åçš„å¤„ç†é€»è¾‘ï¼Œè¿™ä¸€ç¯‡æˆ‘ä»¬å°±æ¥å¼€å‘è´­ä¹°ä¼šå‘˜çš„åŠŸèƒ½ã€‚

## é€‰æ‹©æ”¯ä»˜å·¥å…·

é¦–å…ˆï¼Œæˆ‘ä»¬è¦é€‰æ‹©æ”¯ä»˜å¹³å°å’Œå·¥å…·ã€‚å¦‚æœä½ çš„äº§å“ç«‹è¶³å›½å†…ï¼Œé‚£ä¹ˆç”¨æ”¯ä»˜å®å’Œå¾®ä¿¡æ”¯ä»˜å°±è¶³å¤Ÿï¼Œå¦‚æœä½ çš„äº§å“è¿˜æƒ³æ”¾çœ¼æµ·å¤–ï¼Œæˆ‘æ¨èä½¿ç”¨Lemon Squeezyï¼ŒåŸå› æœ‰ä¸¤ä¸ªï¼š

1. Lemon Squeezyä¼šæ ¹æ®ç”¨æˆ·æ‰€åœ¨åœ°åŒºæä¾›ä¸åŒçš„ä»˜è´¹é€šé“ï¼Œå…¶ä¸­åŒ…æ‹¬å¾®ä¿¡ã€æ”¯ä»˜å®ã€ä¿¡ç”¨å¡å’ŒPaypalç­‰å…¨çƒå¸¸è§çš„æ”¯ä»˜æ–¹å¼ã€‚
2. Lemon Squeezyä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ”¯ä»˜æ¥å…¥å¹³å°ï¼Œå®ƒæ›´åƒä¸€ä¸ªå®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚ï¼šå®ƒå¯ä»¥å¸®ä½ ç®¡ç†è®¢é˜…çš„è‡ªåŠ¨ç»­è´¹ï¼Œè€Œå¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å®è¿™æ ·çš„æ¸ é“åªæœ‰æ”¶ä»˜æ¬¾åŠŸèƒ½ï¼Œæ”¶ä»˜æ¬¾ä»¥å¤–çš„é€»è¾‘éœ€è¦ä½ è‡ªå·±è®¾è®¡å¼€å‘ã€‚

ä¸Šä¸€ç¯‡æ–‡ç« æˆ‘ä»¬è®¾è®¡äº†ä¸¤ä¸ªä»˜è´¹åŠŸèƒ½ï¼šæœˆåº¦ä¼šå‘˜å’ŒåŠ æ²¹åŒ…ã€‚æœ¬æ–‡ä»å»¶ç»­è¿™æ ·çš„ä¼šå‘˜æ–¹æ¡ˆè®¾è®¡ï¼Œå¹¶åŸºäºLemon Squeezyæ¥å¼€å‘å®ƒä»¬ã€‚

å…³äºLemon Squeezyçš„çŸ¥è¯†å°±ä¸èµ˜è¿°äº†ï¼Œè¿™äº›éƒ½æ˜¯å¯ä»¥é€šè¿‡å•ƒå®˜æ–¹æ–‡æ¡£å­¦åˆ°çš„çŸ¥è¯†ï¼Œå¦‚æœç¡®æœ‰æä¸æ¸…æ¥šçš„åœ°æ–¹ï¼Œè¯·è¯„è®ºåŒºæé—®ï½ã€‚

æ¬¢è¿åŠ å…¥ã€ŒğŸŒ[ç‹¬ç«‹å…¨æ ˆå¼€å‘äº¤æµç¾¤](/make-a-friend)ã€ï¼Œä¸€èµ·èµšç¾åˆ€ã€‚

## è®¾ç½®Lemon Squeezyäº§å“

åœ¨Lemon Squeezyçš„åå°ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªäº§å“ï¼Œåœ¨åˆ›å»ºäº§å“çš„ä¾§æ é‡Œï¼Œè¦æ·»åŠ ä¸¤ä¸ªvaiantï¼Œå¯ä»¥ç†è§£ä¸ºåŒä¸€ä¸ªäº§å“çš„ä¸åŒå‹å·ï¼Œè·Ÿä½ ç½‘è´­æ—¶ä¸€æ ·ï¼Œæ·»åŠ ä¸åŒå‹å·å¯ä»¥æ–¹ä¾¿ç”¨æˆ·åœ¨ä¸€ä¸ªäº§å“é“¾æ¥é‡Œåˆ‡æ¢è‡ªå·±æƒ³ä»˜è´¹è´­ä¹°çš„æœåŠ¡ã€‚

![1.png](/assets/032/1.png)

æ»šåŠ¨æ¡æ»šåˆ°åº•éƒ¨ï¼Œåœ¨Confirmation modalé‡Œè®¾ç½®ä»˜è´¹æˆåŠŸåçš„è¿”å›åœ°å€ï¼Œé»˜è®¤æ˜¯è·³åˆ°Lemon Squeezyçš„è®¢å•é¡µï¼Œå»ºè®®è®¾ç½®ä¸ºè‡ªå·±çš„ç½‘ç«™ï¼Œå³ç”¨æˆ·è¿›å…¥ä»˜è´¹é¡µé¢å‰çš„URL

![2.png](/assets/032/2.png)

ç„¶åé€šè¿‡é¡µé¢ä¸Šå’Œä¾§æ å¡ç‰‡é‡Œçš„ã€Œ`â€¦`ã€æŒ‰é’®è·å–`store_id`ã€`product_id`å’Œ`variant_id`ï¼Œå¹¶åŠ å…¥ç¯å¢ƒå˜é‡

```bash
# .env

# Subscriptions
LEMON_SQUEEZY_HOST=https://api.lemonsqueezy.com/v1
LEMON_SQUEEZY_API_KEY=
LEMON_SQUEEZY_STORE_ID=
LEMON_SQUEEZY_PRODUCT_ID=
LEMON_SQUEEZY_MEMBERSHIP_MONTHLY_VARIANT_ID=
LEMON_SQUEEZY_MEMBERSHIP_SINGLE_TIME_VARIANT_ID=
LEMONS_SQUEEZY_SIGNATURE_SECRET=
```

æˆ‘ä»¬ä½¿ç”¨`lemonsqueezy.ts`æ¥è¿›è¡Œå¼€å‘

```bash
yarn add lemonsqueezy.ts
```

åˆå§‹åŒ–`lemonsqueezy`

```tsx
// lib/lemonsqueezy/lemons.ts

import { LemonsqueezyClient } from "lemonsqueezy.ts";
export const client = new LemonsqueezyClient(process.env.LEMON_SQUEEZY_API_KEY as string);
```

## è·å–è´­ä¹°é“¾æ¥

æˆ‘ä»¬éœ€è¦åœ¨å‰ç«¯å±•ç¤ºä¸€ä¸ªå¼•å¯¼ç”¨æˆ·è´­ä¹°ä¼šå‘˜çš„åŒºåŸŸï¼Œé€šè¿‡ä¸åŒè§’è‰²çš„æƒé™å¯¹æ¯”ï¼Œçªå‡ºä»˜è´¹ç”¨æˆ·çš„å¯è·å¾—çš„ä¼˜åŠ¿ï¼Œä¾‹å¦‚å›¾ç‰‡é‡Œè¿™æ ·ï¼š

![3.png](/assets/032/3.png)

ä¸­é—´çš„å¡ç‰‡æ˜¯å‡çº§æœˆåº¦ä¼šå‘˜ï¼Œå³è¾¹çš„å¡ç‰‡æ˜¯è´­ä¹°åŠ æ²¹åŒ…ã€‚

å¡ç‰‡ä¸Šçš„æŒ‰é’®æ˜¯ç”¨æ¥è¯·æ±‚åå°è·å–ä»˜è´¹é“¾æ¥çš„ï¼š

```tsx
const subscribe = async (vairant) => {
    if (!user || !user.userId) {
      toast.error("Please login first");
      return;
    }
    try {
      const { checkoutURL } = await axios.post<any, CreateCheckoutResponse>(
        "/api/payment/subscribe",
        { userId: user.userId, type: vairant } // å› ä¸ºä¸€ä¸ªäº§å“æœ‰ä¸¤ä¸ªvariantï¼Œæ‰€ä»¥éœ€è¦ä¼ é€’variantç”¨äºåˆ¤æ–­
      );
			// åœ¨å“åº”ä¸­è·å–åˆ°è´­ä¹°URLï¼Œå®¢æˆ·ç«¯å°†æŠŠç”¨æˆ·é‡å®šå‘åˆ°è¯¥URLï¼Œç”¨æˆ·å¯åœ¨è¯¥URLå†…è¿›è¡Œä»˜è´¹å’Œè·³è½¬
      window.location.href = checkoutURL;
    } catch (err) {
      console.log(err);
    }
  };
```

åç«¯æ·»åŠ å¯¹åº”æ¥å£

```tsx
// app/api/payment/subscribe/route.ts

import { axios } from "@/lib/axios";
import prisma from "@/lib/prisma";
import type { CreateCheckoutResult } from "lemonsqueezy.ts/dist/types";
import { NextResponse } from "next/server";

const VARIANT_IDS_BY_TYPE = {
  'subscription': process.env.LEMON_SQUEEZY_MEMBERSHIP_MONTHLY_VARIANT_ID || '', // checkouts è¯·æ±‚ä¼ å‚è¦ç”¨stringï¼Œä½†æ˜¯webhookæ”¶åˆ°çš„variant_idæ˜¯number
  'single': process.env.LEMON_SQUEEZY_MEMBERSHIP_SINGLE_TIME_VARIANT_ID || '',
}

export async function POST(request: Request) {
  try {
    const { userId, type } = await request.json() as { userId: string, type: UpgradeType };
    // æ£€æŸ¥ç”¨æˆ·å’Œvariantæ˜¯å¦å­˜åœ¨
		if (!userId) {
      return NextResponse.json({ message: "Your account was not found" }, { status: 401 });
    }
		const variantId = VARIANT_IDS_BY_TYPE[type]
    if (!type || !variantId) {
      return NextResponse.json({ message: "The variant was not found" }, { status: 401 });
    }
    const user = await prisma.user.findUnique({
      where: { userId: userId.toString() },
      select: { userId: true, email: true, username: true },
    });
    if (!user) return NextResponse.json({ message: "Your account was not found" }, { status: 401 });
    
		// é€šè¿‡ API è·å–è´­ä¹°é“¾æ¥
		const checkout = (await axios.post(
      `${process.env.LEMON_SQUEEZY_HOST}/checkouts`,
      {
        data: {
          type: "checkouts",
          attributes: { checkout_data: { custom: { email: user.email, userId: user.userId, username: user.username, type } } },
          relationships: {
            store: { data: { type: "stores", id: process.env.LEMON_SQUEEZY_STORE_ID } },
            variant: { data: { type: "variants", id: variantId.toString() } },
          },
        },
      },
      {
        headers: {
          Authorization: `Bearer ${process.env.LEMON_SQUEEZY_API_KEY}`,
          Accept: 'application/vnd.api+json',
          'Content-Type': 'application/vnd.api+json'
        }
      }
    )) as CreateCheckoutResult;

    return NextResponse.json({ checkoutURL: checkout.data.attributes.url }, { status: 200 });
  } catch (err: any) {
    return NextResponse.json({ message: err.message || err }, { status: 500 });
  }
}
```

å…¶ä¸­ï¼Œ`attributes.checkout_data.custom`æ˜¯è‡ªå®šä¹‰å­—æ®µï¼Œå¯ä»¥æŠŠç”¨æˆ·æ ‡è¯†ä¼ è¿›å»ï¼Œåœ¨ç”¨æˆ·ä»˜è´¹å®Œæˆåï¼ŒLemon Squeezyä¼šä¸€èµ·æŠŠ`custom`å†…çš„ä¿¡æ¯ä¼ å›æ¥ï¼ˆä¸‹æ–‡ä»‹ç»ï¼‰ã€‚

## æ¥æ”¶Lemon Squeezyäº‹ä»¶æ¨é€

åœ¨å¾®ä¿¡å¼€å‘é‡Œï¼Œæˆ‘ä»¬é€šå¸¸å«â€œäº‹ä»¶æ¨é€â€ï¼Œåœ¨Lemon Squeezyé‡Œå«åšWebhooksï¼Œå®ƒä»¬çš„ä½œç”¨æ˜¯ä¸€æ ·ï¼Œéƒ½æ˜¯ç”¨æ¥æ¥æ”¶ç¬¬ä¸‰æ–¹å¹³å°æ¨é€çš„æ•°æ®ï¼Œç”¨äºé—­ç¯å¤„ç†æˆ‘ä»¬è‡ªå·±å¹³å°å†…çš„é€»è¾‘ã€‚

æ­¤æ—¶æˆ‘ä»¬éœ€è¦å†…ç½‘ç©¿é€ï¼Œæ¨èä½¿ç”¨Localtunnelæˆ–è€…VSCodeæœ€æ–°ç‰ˆè‡ªå¸¦çš„ç©¿é€åŠŸèƒ½ï¼Œå¯ä»¥çœ‹ã€ŠğŸ‘‰[å†…ç½‘ç©¿é€ç®€ä»‹](/article/port-forwarding)ã€‹ã€‚

æœ‰äº†ç©¿é€åœ°å€åï¼Œåˆ°Lemon Squeezyé‡Œè®¾ç½®Webhooks

![4.png](/assets/032/4.png)

å¦‚æœä½ è¦ç”¨æ¥æ¥æ”¶äº‹ä»¶æ¨é€çš„æ¥å£æ˜¯`/api/payment/webhooks`ï¼Œé‚£ä¹ˆCallback URLåº”è¯¥å¡«å…¥`http://[YOUR URL]/api/payment/webhooks`ã€‚

Signing Secretå°±æ˜¯ç¯å¢ƒå˜é‡é‡Œçš„`LEMONS_SQUEEZY_SIGNATURE_SECRET`ã€‚

äº‹ä»¶éœ€å‹¾é€‰`order_created`ã€`subscription_created`ã€`subscription_updated`ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬åˆ›å»ºå¯¹åº”çš„API

```tsx
// app/api/payment/webhooks/route.ts

import dayjs from "dayjs";
import { headers } from "next/headers";
import { Buffer } from "buffer";
import crypto from "crypto";
import rawBody from "raw-body";
import { Readable } from "stream";
import { NextResponse } from "next/server";
import { client } from "@/lib/lemonsqueezy/lemons";
import prisma from "@/lib/prisma";
import redis from "@/lib/redis";
import { boostPack } from "@/lib/upgrade/upgrade";
import { clearTodayUsage } from "@/lib/usage/usage";

export async function POST(request: Request) {
  console.log('webhook');
  const body = await rawBody(Readable.from(Buffer.from(await request.text())));
  const headersList = headers();
  const payload = JSON.parse(body.toString());

  const sigString = headersList.get("x-signature");
  if (!sigString) {
    console.error(`Signature header not found`);
    return NextResponse.json({ message: "Signature header not found" }, { status: 401 });
  }
  const secret = process.env.LEMONS_SQUEEZY_SIGNATURE_SECRET as string;
  const hmac = crypto.createHmac("sha256", secret);
  const digest = Buffer.from(hmac.update(body).digest("hex"), "utf8");
  const signature = Buffer.from(
    Array.isArray(sigString) ? sigString.join("") : sigString || "",
    "utf8"
  );
  // æ ¡éªŒç­¾å
  if (!crypto.timingSafeEqual(digest, signature)) {
    return NextResponse.json({ message: "Invalid signature" }, { status: 403 });
  }

  const userId = payload.meta.custom_data && payload.meta.custom_data.userId || '';
  // æ£€æŸ¥customé‡Œçš„å‚æ•°
	if (!userId) return NextResponse.json({ message: "No userId provided" }, { status: 403 });

	// æ­£å¼å¤„ç†
  const first_order_item = payload.data.attributes.first_order_item || null
  // åŠ æ²¹åŒ…
  if (first_order_item && parseInt(first_order_item.variant_id) === parseInt(process.env.LEMON_SQUEEZY_MEMBERSHIP_SINGLE_TIME_VARIANT_ID as string)) {
    return await singlePay(first_order_item, payload, userId)
  }
  // æœˆåº¦è®¢é˜…
  if (!first_order_item && parseInt(payload.data.attributes.variant_id) === parseInt(process.env.LEMON_SQUEEZY_MEMBERSHIP_MONTHLY_VARIANT_ID as string)) {
    return await subscription(payload, userId)
  }
}
```

å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œåœ¨æ­£å¼å¤„ç†æ•°æ®ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¯¹ç­¾åè¿›è¡Œæ ¡éªŒï¼Œç„¶ååˆ¤æ–­`custom`é‡Œçš„å­—æ®µæœ‰æ•ˆæ€§ã€‚

è´­ä¹°åŠ æ²¹åŒ…å±äºä¸€æ¬¡æ€§è´­ä¹°ï¼Œè´­ä¹°é˜…è¯»ä¼šå‘˜æ˜¯æŒ‰æœˆç»­è´¹ï¼Œä¸¤ç§è´­ä¹°æ–¹å¼æ”¶åˆ°çš„æ•°æ®ç»“æ„æ˜¯ä¸ä¸€æ ·çš„ï¼Œå¯ä»¥é€šè¿‡`first_order_item`å­—æ®µè¿›è¡ŒåŒºåˆ†ï¼Œä¸€æ¬¡æ€§è´­ä¹°çš„è®¢å•æœ‰è¿™ä¸ªå­—æ®µï¼ˆæ˜¯ä¸€ä¸ªåŒ…å«è®¢å•æ ¸å¿ƒä¿¡æ¯çš„å¯¹è±¡ï¼‰ï¼Œè€ŒæŒ‰æœˆç»­è´¹çš„åˆ™æ²¡æœ‰ã€‚

### è´­ä¹°åŠ æ²¹åŒ…

```tsx
const getSinglePayOrderKey = ({ identifier }: { identifier: string }) => {
  return `single_${identifier}`
}

const singlePay = async (first_order_item, payload, userId) => {
  try {
		// åˆ¤æ–­productæ˜¯å¦æ­£ç¡®
    if (
      parseInt(first_order_item.product_id) !==
      parseInt(process.env.LEMON_SQUEEZY_PRODUCT_ID as string)
    ) {
      return NextResponse.json({ message: "Invalid product" }, { status: 403 });
    }
		// åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨
	  const user = await prisma.user.findUnique({
	    where: { userId: userId.toString() },
	    select: { userId: true, email: true, username: true },
	  });
	  if (!user) return NextResponse.json({ message: "Your account was not found" }, { status: 401 });

    switch (payload.meta.event_name) {
      case "order_created": {
        const subscription = await client.retrieveOrder({ id: payload.data.id });
        // Lemon Squeezy å¯èƒ½æ¨é€å¤šæ¬¡ï¼Œè¿™é‡Œéœ€è¦åˆ¤æ–­orderæ˜¯å¦å·²å­˜åœ¨ï¼Œç›¸åŒorderä»…å¤„ç†é¦–æ¬¡æ”¶åˆ°çš„æ¨é€
				 // æ£€æŸ¥redisé‡Œæœ‰æ²¡æœ‰å­˜è¿™ä¸ªorder_idï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è°ƒç”¨boostPackå’Œredisä¿å­˜ï¼Œå¦‚æœæœ‰ï¼Œåˆ™ä¸å¤„ç†ï¼Œç›´æ¥è¿”å›200
        const key = await getSinglePayOrderKey({ identifier: payload.data.attributes.identifier })
        const orderRedisRes = await redis.get(key)
				 // å¦‚æœredisé‡Œæ²¡æœ‰è¿™ä¸ªkeyï¼Œåˆ™è¯´æ˜æ˜¯é¦–æ¬¡æ¨é€
        if (!orderRedisRes) {
          await redis.setex(key, ONE_DAY, first_order_item.created_at) // keyæœ‰æ•ˆæœŸ1å¤©
          await boostPack({ userId }) // è°ƒç”¨ä¸Šä¸€ç¯‡æ–‡ç« è®¾è®¡çš„ boostPack æ–¹æ³•
          return NextResponse.json({ status: 200 });
        }
        return NextResponse.json({ status: 200 }); // è¿”å›200ï¼ŒLemon Squeezyæ‰ä¼šè®¤ä¸ºä½ å·²ç»æŠŠä¸šåŠ¡é—­ç¯
      }

      default: {
        return NextResponse.json({ massage: 'event_name not support' }, { status: 400 });
      }
    }
  } catch (e) {
    return NextResponse.json({ message: 'single pay something wrong' }, { status: 500 });
  }
}
```

- ä¸€æ¬¡æ€§è´­ä¹°åªéœ€è¦å¤„ç†`order_created`äº‹ä»¶
- Lemon Squeezyæœ‰ä¸€ä¸ªæ¨é€æœºåˆ¶ï¼Œæœ€å¤šæ¨é€4æ¬¡ä»¥ç¡®ä¿æˆ‘ä»¬èƒ½å¤Ÿé—­ç¯è´­ä¹°é€»è¾‘ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®°å½•è®¢å•ä¿¡æ¯ï¼Œé€šè¿‡åˆ¤æ–­`identifier`ï¼ˆå…·å¤‡å”¯ä¸€æ€§ï¼‰æ˜¯å¦æ˜¯æ–°è®¢å•æ¥é¿å…é‡å¤æ·»åŠ åŠ æ²¹åŒ…
- Lemon Squeezyéœ€è¦æ”¶åˆ°`status`ä¸º200çš„è¿”å›æ‰ä¼šè®¤ä¸ºä½ æ­£ç¡®å¤„ç†äº†äº‹ä»¶æ¨é€ï¼Œå¦‚æœ`status`ä¸æ˜¯200ï¼Œåˆ™åœ¨åå°å¯ä»¥çœ‹åˆ°é”™è¯¯ä¿¡æ¯

### è®¢é˜…æœˆåº¦ä¼šå‘˜

Lemon Squeezyå¯ä»¥å¸®æˆ‘ä»¬å®ç°è®°å½•è®¢é˜…ç”¨æˆ·ã€ç»­è´¹æ–¹å¼ã€è‡ªåŠ¨ç»­è´¹ç­‰å¤šç§ä»˜è´¹åçš„é€»è¾‘å¤„ç†ï¼Œæ‰€ä»¥æ¥æ”¶è®¢é˜…é˜…è¯»ä¼šå‘˜çš„é€»è¾‘æ²¡æœ‰è°ƒç”¨ä¸Šä¸€ç¯‡æ–‡ç« å®ç°çš„å‡½æ•°ã€‚ä¿å­˜ä¼šå‘˜ä¿¡æ¯çš„æ–¹å¼ä¹Ÿè¢«æˆ‘æ”¹äº†ï¼Œæ²¡æœ‰å­˜åœ¨Redisé‡Œï¼Œè€Œæ˜¯ç›´æ¥å­˜åˆ°Postgresæ•°æ®åº“äº†ã€‚

```tsx
const subscription = async (payload, userId) => {
  try {
    const attributes = payload.data.attributes
		// åˆ¤æ–­productæ˜¯å¦æ­£ç¡®
    if (
      parseInt(attributes.product_id) !==
      parseInt(process.env.LEMON_SQUEEZY_PRODUCT_ID as string)
    ) {
      return NextResponse.json({ message: "Invalid product" }, { status: 403 });
    }

    switch (payload.meta.event_name) {
      case "subscription_created": {
        const subscription = await client.retrieveSubscription({ id: payload.data.id });
        // è®¢é˜…
        await prisma.user.update({
          where: { userId },
          data: {
            subscriptionId: `${subscription.data.id}`,
            customerId: `${payload.data.attributes.customer_id}`,
            variantId: subscription.data.attributes.variant_id,
            currentPeriodEnd: dayjs(subscription.data.attributes.renews_at).unix(),
          },
        });
        // æ¸…ç©ºä»Šå¤©å·²ç”¨æ¬¡æ•°
        clearTodayUsage({ userId })
        return NextResponse.json({ status: 200 });
      }

      case "subscription_updated": {
        const subscription = await client.retrieveSubscription({ id: payload.data.id });
        // æ›´æ–° è®¢é˜…
        const user = await prisma.user.findUnique({
          where: { userId, subscriptionId: `${subscription.data.id}` },
          select: { subscriptionId: true },
        });
				 if (!user || !user.subscriptionId) return NextResponse.json({ massage: 'userId or subscriptionId not found' }, { status: 400 });;

        await prisma.user.update({
          where: { userId, subscriptionId: user.subscriptionId },
          data: {
            variantId: subscription.data.attributes.variant_id,
            currentPeriodEnd: dayjs(subscription.data.attributes.renews_at).unix(),
          },
        });
        // æ¸…ç©ºä»Šå¤©å·²ç”¨æ¬¡æ•°
        clearTodayUsage({ userId })
        return NextResponse.json({ status: 200 });
      }

      default: {
        return NextResponse.json({ massage: 'event_name not support' }, { status: 400 });
      }
    }
  } catch (e) {
    console.log('subscription deal', e);
    return NextResponse.json({ message: 'subscription something wrong' }, { status: 500 });
  }
}
```

- æŒ‰æœˆè®¢é˜…çš„æ¨é€æ•°æ®ä»`payload.data.attributes`é‡Œè¯»å–
- æŒ‰æœˆè®¢é˜…çš„è®¢å•ï¼ŒLemon Squeezyä¼šåœ¨åˆ°æœŸåé»˜è®¤è¿›è¡Œç»­è´¹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç›‘å¬`subscription_created`å’Œ`subscription_updated`ä¸¤ä¸ªäº‹ä»¶ï¼Œå‰è€…æ˜¯åˆ›å»ºè®¢é˜…æ—¶è§¦å‘ï¼Œåè€…æ˜¯åˆ›å»ºè®¢é˜…å’Œæ›´æ–°è®¢é˜…ï¼ˆåŒ…å«ç»­è®¢ã€å–æ¶ˆç­‰ï¼‰éƒ½ä¼šè§¦å‘
- `subscription_created`çš„å¤„ç†ä¸­ï¼Œå»ºè®®è®°å½•`subcriptionId`ï¼ˆè®¢é˜…çš„Idï¼‰ã€`customerId`ï¼ˆLemon Squeezyè®°å½•çš„ç”¨æˆ·Idï¼‰ã€`variantId`ï¼ˆvariant Idï¼‰å’Œ`currentPeriodEnd`ï¼ˆåˆ°æœŸæ—¶é—´ï¼‰
- `subscription_updated`çš„å¤„ç†ä¸­ï¼Œéœ€è¦æ›´æ–°`variantId`å’Œ`currentPeriodEnd`

## å‰ç«¯å±•ç¤ºè®¢é˜…ä¿¡æ¯

æˆ‘ä»¬å·²ç»å®Œæˆä¸Lemon Squeezyçš„åŠŸèƒ½å¯¹æ¥ï¼Œç°åœ¨æœ€åä¸€æ­¥å°±æ˜¯è¦æŠŠç”¨æˆ·çš„è®¢é˜…/è´­ä¹°ä¿¡æ¯å±•ç¤ºç»™ç”¨æˆ·ã€‚

åŠ æ²¹åŒ…çš„ä¿¡æ¯ä»Redisé‡Œè¯»å–å°±å¯ä»¥ï¼Œå’Œä¸Šä¸€ç¯‡æ–‡ç« çš„é€»è¾‘ä¸€æ ·ã€‚

æŒ‰æœˆè®¢é˜…çš„ä¿¡æ¯åˆ™è¦ä»æ•°æ®åº“ä¸­è¯»å–ï¼š

```tsx
/
 * lib/lemonsqueezy/subscription.ts
 * ä»æ•°æ®åº“é‡Œè¯»å–ç”¨æˆ·è§’è‰²å’Œä¼šå‘˜è¿‡æœŸæ—¶é—´
 */
import prisma from "@/lib/prisma";
import { SubScriptionInfo } from "@/types/subscribe";
import { PrismaUser } from "@/types/user";

export async function getUserSubscriptionStatus({ userId, defaultUser }: { userId: string; defaultUser?: PrismaUser }) {
  let user = null
  if (defaultUser) {
    user = defaultUser
  } else {
    user = await prisma.user.findUnique({
      where: { userId },
      select: {
        subscriptionId: true,
        currentPeriodEnd: true,
        customerId: true,
        variantId: true,
      },
    });
  }

  if (!user) throw new Error("User not found");

  const membershipExpire = (user.currentPeriodEnd || 1) * 1000 // 13ä½æ—¶é—´æˆ³æˆ–éä¼šå‘˜
  const isMembership =
    user.variantId &&
    membershipExpire > Date.now().valueOf();

  return {
    subscriptionId: user.subscriptionId,
    membershipExpire: isMembership ? membershipExpire : 1,
    customerId: user.customerId,
    variantId: user.variantId,
    role: isMembership ? 2 : 1, // ä¼šå‘˜ : æ™®é€šç”¨æˆ·
  } as SubScriptionInfo;
}
```

- é€šè¿‡è¿‡æœŸæ—¶é—´åˆ¤æ–­ç”¨æˆ·å½“å‰çš„è§’è‰²

æŠŠåŠ æ²¹åŒ…ã€æœˆåº¦ä¼šå‘˜ã€ç”¨æˆ·ä½¿ç”¨æ¬¡æ•°æ•°æ®æ±‡æ€»åˆ°ä¸€ä¸ªæ–¹æ³•é‡Œï¼š

```tsx
// lib/upgrade/checkStatus.ts

export const checkStatus = async ({ userId }: UserId) => {
  // è·å–ç”¨æˆ·è®¢é˜…ä¿¡æ¯ï¼ˆè§’è‰²ã€ä¼šå‘˜åˆ°æœŸæ—¶é—´æˆ³ï¼‰
  const subscriptionRes = await getUserSubscriptionStatus({
    userId,
  })
  // æ ¹æ®è§’è‰²è®¡ç®—å½“æ—¥å‰©ä½™æ¬¡æ•°
  const remainingInfo: DateRemaining = await getUserDateRemaining({ userId, role: subscriptionRes.role }) // ç”¨æˆ·è§’è‰²ã€å½“æ—¥å‰©ä½™æ¬¡æ•°ã€åŠ æ²¹åŒ…å‰©ä½™æ¬¡æ•°

  // å¦‚æœåŠ æ²¹åŒ…æ¬¡æ•°å¤§äº0ï¼Œè®¡ç®—åŠ æ²¹åŒ…åˆ°æœŸæ—¶é—´
  let boostPackExpire = 0
  if (remainingInfo.boostPackRemaining > 0) {
    const boostPackKey = await getBoostPackKey({ userId })
    boostPackExpire = await redis.ttl(boostPackKey)
  }
  return {
    role: subscriptionRes.role,
    todayRemaining: remainingInfo.userTodayRemaining,
    membershipExpire: subscriptionRes.membershipExpire,
    boostPackRemaining: remainingInfo.boostPackRemaining,
    boostPackExpire: boostPackExpire,
  }
}
```

æœåŠ¡ç«¯ç»„ä»¶è°ƒç”¨è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥è·å–åˆ°æ‰€æœ‰å¿…å¤‡ä¿¡æ¯ï¼Œå¹¶å±•ç¤ºåˆ°å‰ç«¯äº†ã€‚

## ç»“è¯­

æ— è®ºä½ ä½¿ç”¨å“ªä¸ªæ”¯ä»˜å¹³å°å’Œå·¥å…·ï¼Œå¼€å‘èµ·æ¥çš„åŸç†éƒ½å·®ä¸å¤šï¼Œåªæœ‰ä¸¤ä¸ªè¦ç‚¹ï¼š

1. è·å–æ”¯ä»˜é¡µé¢é“¾æ¥
2. æä¾›Webhooksæ¥æ”¶æ”¯ä»˜å¹³å°çš„äº‹ä»¶æ¨é€ï¼Œç„¶åæ ¹æ®äº‹ä»¶è¿›è¡Œç›¸åº”å¤„ç†

å¦‚æœä½ è¿˜æ²¡ç†æ¸…æ¥šä¼šå‘˜åŠŸèƒ½çš„è®¾è®¡ï¼Œè¯·å‚è€ƒä¸Šä¸€ç¯‡æ–‡ç« ã€Š[ğŸ‘‰å¸¦ä½ è®¾è®¡ä¸€å¥—ä¼šå‘˜åŠŸèƒ½å¹¶å¼€å‘å®ƒ](/article/build-membership-feature)ã€‹ã€‚


## ä¸“æ èµ„æº

ä¸“æ ä»‹ç»ï¼šä»¥å®æˆ˜çš„è§’åº¦è¿›è¡ŒNext.jsç”Ÿæ€åœˆçš„æŠ€æœ¯æ ˆåˆ†äº«ï¼Œå†…å®¹åŒ…æ‹¬ä½†ä¸é™äºï¼šNext.jsç†è®ºçŸ¥è¯†ã€åŠŸèƒ½æ¨¡å—è®¾è®¡æ€è·¯ã€å®æˆ˜ä¸­ä½¿ç”¨åˆ°çš„æŠ€æœ¯æ ˆã€‚è¿™æ˜¯ä¸€ä¸ªé•¿æœŸæ›´æ–°çš„ä¸“æ ï¼Œæˆ‘ä¼šæŒç»­æŠŠè‡ªå·±çš„æ€è€ƒå’Œç»éªŒæç‚¼åˆ†äº«å‡ºæ¥ï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„ä¸“æ ğŸ‘‡

ä¸“æ åœ°å€ï¼šğŸ‘‰[Next.jsç”Ÿæ€åœˆå®æˆ˜](/tag/NextJS%E5%AE%9E%E6%88%98)

ä¸“æ æ¼”ç¤ºç«™ï¼šğŸ‘‰[Next.js Demos](https://nextjs.weijunext.com)

ä¸“æ æºç ä»“åº“ï¼šğŸ‘‰[Github - Source Code](https://github.com/weijunext/nextjs-learn-demos)

äº¤ä¸ªæœ‹å‹ï¼šğŸ‘‰[åŠ å…¥ã€Œç‹¬ç«‹å…¨æ ˆäº¤æµç¾¤ã€](/make-a-friend)
