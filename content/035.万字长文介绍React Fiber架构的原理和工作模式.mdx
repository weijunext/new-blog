---
title: ä¸‡å­—é•¿æ–‡ä»‹ç»React Fiberæ¶æ„çš„åŸç†å’Œå·¥ä½œæ¨¡å¼
description: æœ¬æ–‡ä»React Fiberæ¶æ„çš„åŸç†å’Œæºç å…¥æ‰‹ï¼Œä¸ºä½ ç»‡å¼€ä¸€é¢å…³äºFiberæ¶æ„çš„åŸºç¡€çŸ¥è¯†ç½‘ã€‚
slug: dive-into-react-fiber
tags: React
date: 2023-10-12
---

<Aside>
ä¸ºäº†å†™è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘èŠ±äº†5å¤©æ—¶é—´é˜…è¯»Fiberçš„æ ¸å¿ƒæºç ï¼Œå°½ç®¡æœ¬æ–‡å­—ç¬¦æ•°è¿‡ä¸‡ï¼Œä½†ç›¸å¯¹äºå‡ åä¸‡è¡ŒFiberæºç æ¥è¯´ï¼Œåªèƒ½ç®—æ˜¯ä»‹ç»äº†Fiberçš„åŸºç¡€çŸ¥è¯†ï¼Œæ‰€ä»¥å¦‚æœå†…å®¹æœ‰çº°æ¼ï¼Œè¯·åœ¨è¯„è®ºåŒºä¸ºæˆ‘æŒ‡æ­£ï¼Œæˆ‘ä¼šè¿›è¡Œæ›´æ–°ï¼Œå¦‚æœé˜…è¯»æ–‡ç« åæœ‰å“ªä¸ªå…³äºFiberçš„ä¸“é¢˜ä½ æƒ³äº†è§£ï¼Œä¹Ÿå¯ä»¥è¯„è®ºåŒºæå‡ºæ¥ï¼Œæˆ‘å¾ˆä¹æ„ç»§ç»­ç ”ç©¶æºç å’Œåˆ†äº«çŸ¥è¯†ã€‚

</Aside>

è‡ªReact 16å¼€å§‹ï¼ŒReactå¼•å…¥äº†**Fiber**æ¶æ„ï¼Œè§£å†³äº†ä»¥å‰çš„æ›´æ–°æœºåˆ¶çš„é—®é¢˜ï¼Œå³åœ¨é•¿æ—¶é—´çš„æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œä¸»çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œå¯¼è‡´åº”ç”¨æ— æ³•åŠæ—¶å“åº”ç”¨æˆ·è¾“å…¥ã€‚æœ¬æ–‡æˆ‘ä»¬å°±æ¥èŠèŠFiberæ˜¯ä»€ä¹ˆä»¥åŠå®ƒçš„åº•å±‚åŸç†ï¼Œå­¦ä¹ å®Œæœ¬æ–‡å¯ä»¥è®©ä½ å¯¹Fiberæ¶æ„çš„åŸç†æœ‰ä¸€ä¸ªæ¯”è¾ƒæ¸…æ™°çš„è®¤è¯†ã€‚

æœ¬æ–‡é¦–å‘äºæˆ‘çš„åšå®¢ã€Œ**ğŸ‘‰[Jå®éªŒå®¤](https://weijunext.com)**ã€

æ¬¢è¿åŠ å…¥ã€ŒğŸŒ[ç‹¬ç«‹å…¨æ ˆå¼€å‘äº¤æµç¾¤](/make-a-friend)ã€ï¼Œä¸€èµ·å­¦ä¹ äº¤æµå‰ç«¯å’ŒNodeç«¯æŠ€æœ¯

## Fiberæ˜¯ä»€ä¹ˆï¼Ÿ

é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆèŠèŠReactçš„åŸºæœ¬ç»„æˆï¼šå½“æˆ‘ä»¬å†™Reactç»„ä»¶å¹¶ä½¿ç”¨JSXæ—¶ï¼ŒReactåœ¨åº•å±‚ä¼šå°†JSXè½¬æ¢ä¸ºå…ƒç´ çš„å¯¹è±¡ç»“æ„ã€‚ä¾‹å¦‚ï¼š

```tsx
const element = <h1>Hello, world</h1>;
```

ä¸Šè¿°ä»£ç ä¼šè¢«è½¬æ¢ä¸ºä»¥ä¸‹å½¢å¼ï¼š

```tsx
const element = React.createElement(
  'h1',
  null,
  'Hello, world'
);
```

ä¸ºäº†å°†è¿™ä¸ªå…ƒç´ æ¸²æŸ“åˆ°DOMä¸Šï¼ŒReactéœ€è¦åˆ›å»ºä¸€ç§å†…éƒ¨å®ä¾‹ï¼Œç”¨æ¥è¿½è¸ªè¯¥ç»„ä»¶çš„æ‰€æœ‰ä¿¡æ¯å’ŒçŠ¶æ€ã€‚åœ¨æ—©æœŸç‰ˆæœ¬çš„Reactä¸­ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œå®ä¾‹â€æˆ–â€œè™šæ‹ŸDOMå¯¹è±¡â€ã€‚ä½†åœ¨Fiberæ¶æ„ä¸­ï¼Œè¿™ä¸ªæ–°çš„å·¥ä½œå•å…ƒå°±å«åšFiberã€‚

æ‰€ä»¥ï¼Œåœ¨æœ¬è´¨ä¸Šï¼Œ**Fiberæ˜¯ä¸€ä¸ªJavaScriptå¯¹è±¡**ï¼Œä»£è¡¨Reactçš„ä¸€ä¸ªå·¥ä½œå•å…ƒï¼Œå®ƒåŒ…å«äº†ä¸ç»„ä»¶ç›¸å…³çš„ä¿¡æ¯ã€‚ä¸€ä¸ªç®€åŒ–çš„Fiberå¯¹è±¡é•¿è¿™æ ·ï¼š

```tsx
{
  type: 'h1',  // ç»„ä»¶ç±»å‹
  key: null,   // React key
  props: { ... }, // è¾“å…¥çš„props
  state: { ... }, // ç»„ä»¶çš„state (å¦‚æœæ˜¯classç»„ä»¶æˆ–å¸¦æœ‰stateçš„functionç»„ä»¶)
  child: Fiber | null,  // ç¬¬ä¸€ä¸ªå­å…ƒç´ çš„Fiber
  sibling: Fiber | null,  // ä¸‹ä¸€ä¸ªå…„å¼Ÿå…ƒç´ çš„Fiber
  return: Fiber | null,  // çˆ¶å…ƒç´ çš„Fiber
  // ...å…¶ä»–å±æ€§
}
```

å½“Reactå¼€å§‹å·¥ä½œæ—¶ï¼Œå®ƒä¼šæ²¿ç€Fiberæ ‘å½¢ç»“æ„è¿›è¡Œï¼Œè¯•å›¾å®Œæˆæ¯ä¸ªFiberçš„å·¥ä½œï¼ˆä¾‹å¦‚ï¼Œæ¯”è¾ƒæ—§çš„propsä¸æ–°çš„propsï¼Œç¡®å®šæ˜¯å¦éœ€è¦æ›´æ–°ç»„ä»¶ç­‰ï¼‰ã€‚å¦‚æœä¸»çº¿ç¨‹æœ‰æ›´é‡è¦çš„å·¥ä½œï¼ˆä¾‹å¦‚ï¼Œå“åº”ç”¨æˆ·è¾“å…¥ï¼‰ï¼Œåˆ™Reactå¯ä»¥ä¸­æ–­å½“å‰å·¥ä½œå¹¶è¿”å›æ‰§è¡Œä¸»çº¿ç¨‹ä¸Šçš„ä»»åŠ¡ã€‚

å› æ­¤ï¼ŒFiberä¸ä»…ä»…æ˜¯ä»£è¡¨ç»„ä»¶çš„ä¸€ä¸ªå†…éƒ¨å¯¹è±¡ï¼Œå®ƒè¿˜æ˜¯Reactçš„è°ƒåº¦å’Œæ›´æ–°æœºåˆ¶çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ã€‚

## ä¸ºä»€ä¹ˆéœ€è¦Fiberï¼Ÿ

åœ¨React 16ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œæ˜¯ä½¿ç”¨é€’å½’çš„æ–¹å¼å¤„ç†ç»„ä»¶æ ‘æ›´æ–°ï¼Œç§°ä¸º**å †æ ˆè°ƒå’Œï¼ˆStack Reconciliationï¼‰**ï¼Œè¿™ç§æ–¹æ³•ä¸€æ—¦å¼€å§‹å°±ä¸èƒ½ä¸­æ–­ï¼Œç›´åˆ°æ•´ä¸ªç»„ä»¶æ ‘éƒ½è¢«éå†å®Œã€‚è¿™ç§æœºåˆ¶åœ¨å¤„ç†å¤§é‡æ•°æ®æˆ–å¤æ‚è§†å›¾æ—¶å¯èƒ½å¯¼è‡´ä¸»çº¿ç¨‹è¢«é˜»å¡ï¼Œä»è€Œä½¿åº”ç”¨æ— æ³•åŠæ—¶å“åº”ç”¨æˆ·çš„è¾“å…¥æˆ–å…¶ä»–é«˜ä¼˜å…ˆçº§ä»»åŠ¡ã€‚

Fiberçš„å¼•å…¥æ”¹å˜äº†è¿™ä¸€æƒ…å†µã€‚Fiberå¯ä»¥ç†è§£ä¸ºæ˜¯Reactè‡ªå®šä¹‰çš„ä¸€ä¸ªå¸¦æœ‰é“¾æ¥å…³ç³»çš„DOMæ ‘ï¼Œæ¯ä¸ªFiberéƒ½ä»£è¡¨äº†ä¸€ä¸ªå·¥ä½œå•å…ƒï¼ŒReactå¯ä»¥åœ¨å¤„ç†ä»»ä½•Fiberä¹‹å‰åˆ¤æ–­æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ—¶é—´å®Œæˆè¯¥å·¥ä½œï¼Œå¹¶åœ¨å¿…è¦æ—¶ä¸­æ–­å’Œæ¢å¤å·¥ä½œã€‚

## Fiberçš„ç»“æ„

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æºç é‡ŒFiberNodeçš„ç»“æ„ï¼š

```tsx
function FiberNode(
  this: $FlowFixMe,
  tag: WorkTag,
  pendingProps: mixed,
  key: null | string,
  mode: TypeOfMode,
) {
  // åŸºæœ¬å±æ€§
  this.tag = tag; // æè¿°æ­¤Fiberçš„å¯åŠ¨æ¨¡å¼çš„å€¼ï¼ˆLegacyRoot = 0; ConcurrentRoot = 1ï¼‰
  this.key = key; // React key
  this.elementType = null; // æè¿°Reactå…ƒç´ çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œå¯¹äºJSX<App />ï¼ŒelementTypeæ˜¯App
  this.type = null; // ç»„ä»¶ç±»å‹
  this.stateNode = null; // å¯¹äºç±»ç»„ä»¶ï¼Œè¿™æ˜¯ç±»çš„å®ä¾‹ï¼›å¯¹äºDOMå…ƒç´ ï¼Œå®ƒæ˜¯å¯¹åº”çš„DOMèŠ‚ç‚¹ã€‚

  // Fiberé“¾æ¥
  this.return = null; // æŒ‡å‘çˆ¶Fiber
  this.child = null; // æŒ‡å‘ç¬¬ä¸€ä¸ªå­Fiber
  this.sibling = null; // æŒ‡å‘å…¶å…„å¼ŸFiber
  this.index = 0; // å­Fiberä¸­çš„ç´¢å¼•ä½ç½®

  this.ref = null; // å¦‚æœç»„ä»¶ä¸Šæœ‰refå±æ€§ï¼Œåˆ™è¯¥å±æ€§æŒ‡å‘å®ƒ
  this.refCleanup = null; // å¦‚æœç»„ä»¶ä¸Šçš„refå±æ€§åœ¨æ›´æ–°ä¸­è¢«åˆ é™¤æˆ–æ›´æ”¹ï¼Œæ­¤å­—æ®µä¼šç”¨äºè¿½è¸ªéœ€è¦æ¸…ç†çš„æ—§ref

	// Props & State
  this.pendingProps = pendingProps; // æ­£åœ¨ç­‰å¾…å¤„ç†çš„æ–°props
  this.memoizedProps = null; // ä¸Šä¸€æ¬¡æ¸²æŸ“æ—¶çš„props
  this.updateQueue = null; // ä¸€ä¸ªé˜Ÿåˆ—ï¼ŒåŒ…å«äº†è¯¥Fiberä¸Šçš„çŠ¶æ€æ›´æ–°å’Œå‰¯ä½œç”¨
  this.memoizedState = null; // ä¸Šä¸€æ¬¡æ¸²æŸ“æ—¶çš„state
  this.dependencies = null; // è¯¥Fiberè®¢é˜…çš„ä¸Šä¸‹æ–‡æˆ–å…¶ä»–èµ„æºçš„æè¿°

	// å·¥ä½œæ¨¡å¼
  this.mode = mode; // æè¿°Fiberå·¥ä½œæ¨¡å¼çš„æ ‡å¿—ï¼ˆä¾‹å¦‚Concurrentæ¨¡å¼ã€Blockingæ¨¡å¼ç­‰ï¼‰ã€‚

  // Effects
  this.flags = NoFlags; // æè¿°è¯¥Fiberå‘ç”Ÿçš„å‰¯ä½œç”¨çš„æ ‡å¿—ï¼ˆåå…­è¿›åˆ¶çš„æ ‡è¯†ï¼‰
  this.subtreeFlags = NoFlags; // æè¿°è¯¥Fiberå­æ ‘ä¸­å‘ç”Ÿçš„å‰¯ä½œç”¨çš„æ ‡å¿—ï¼ˆåå…­è¿›åˆ¶çš„æ ‡è¯†ï¼‰
  this.deletions = null; // åœ¨commité˜¶æ®µè¦åˆ é™¤çš„å­Fiberæ•°ç»„

  this.lanes = NoLanes; // ä¸Reactçš„å¹¶å‘æ¨¡å¼æœ‰å…³çš„è°ƒåº¦æ¦‚å¿µã€‚
  this.childLanes = NoLanes; // ä¸Reactçš„å¹¶å‘æ¨¡å¼æœ‰å…³çš„è°ƒåº¦æ¦‚å¿µã€‚

  this.alternate = null; // Current Treeå’ŒWork-in-progress (WIP) Treeçš„äº’ç›¸æŒ‡å‘å¯¹æ–¹treeé‡Œçš„å¯¹åº”å•å…ƒ

	// å¦‚æœå¯ç”¨äº†æ€§èƒ½åˆ†æ
  if (enableProfilerTimer) {
		// â€¦â€¦
  }

	// å¼€å‘æ¨¡å¼ä¸­
  if (__DEV__) {
    // â€¦â€¦
  }
}
```

å…¶å®å¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ªæ›´å¼ºå¤§çš„è™šæ‹ŸDOMã€‚

## Fiberå·¥ä½œåŸç†

Fiberå·¥ä½œåŸç†ä¸­æœ€æ ¸å¿ƒçš„ç‚¹å°±æ˜¯ï¼šå¯ä»¥ä¸­æ–­å’Œæ¢å¤ï¼Œè¿™ä¸ªç‰¹æ€§å¢å¼ºäº†Reactçš„å¹¶å‘æ€§å’Œå“åº”æ€§ã€‚

å®ç°å¯ä¸­æ–­å’Œæ¢å¤çš„åŸå› å°±åœ¨äºï¼šFiberçš„æ•°æ®ç»“æ„é‡Œæä¾›çš„ä¿¡æ¯è®©Reactå¯ä»¥è¿½è¸ªå·¥ä½œè¿›åº¦ã€ç®¡ç†è°ƒåº¦å’ŒåŒæ­¥æ›´æ–°åˆ°DOM

ç°åœ¨æˆ‘ä»¬æ¥èŠèŠFiberå·¥ä½œåŸç†ä¸­çš„å‡ ä¸ªå…³é”®ç‚¹ï¼š

- **å•å…ƒå·¥ä½œ**ï¼šæ¯ä¸ªFiberèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªå•å…ƒï¼Œæ‰€æœ‰FiberèŠ‚ç‚¹å…±åŒç»„æˆä¸€ä¸ªFiberé“¾è¡¨æ ‘ï¼ˆæœ‰é“¾æ¥å±æ€§ï¼ŒåŒæ—¶åˆæœ‰æ ‘çš„ç»“æ„ï¼‰ï¼Œè¿™ç§ç»“æ„è®©Reactå¯ä»¥ç»†ç²’åº¦æ§åˆ¶èŠ‚ç‚¹çš„è¡Œä¸ºã€‚
- **é“¾æ¥å±æ€§**ï¼š**`child`**ã€**`sibling`** å’Œ **`return`** å­—æ®µæ„æˆäº†Fiberä¹‹é—´çš„é“¾æ¥å…³ç³»ï¼Œä½¿Reactèƒ½å¤Ÿéå†ç»„ä»¶æ ‘å¹¶çŸ¥é“ä»å“ªé‡Œå¼€å§‹ã€ç»§ç»­æˆ–åœæ­¢å·¥ä½œã€‚
    
    ![1.png](/assets/035/1.png)
    
- **åŒç¼“å†²æŠ€æœ¯**ï¼šReactåœ¨æ›´æ–°æ—¶ï¼Œä¼šæ ¹æ®ç°æœ‰çš„Fiberæ ‘ï¼ˆ**Current Tree**ï¼‰åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸´æ—¶æ ‘ï¼ˆ**Work-in-progress (WIP) Tree**ï¼‰ï¼ŒWIP-TreeåŒ…å«äº†å½“å‰æ›´æ–°å—å½±å“çš„æœ€é«˜èŠ‚ç‚¹ç›´è‡³å…¶æ‰€æœ‰å­å­™èŠ‚ç‚¹ã€‚Current Treeæ˜¯å½“å‰æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šçš„è§†å›¾ï¼ŒWIP-Treeåˆ™æ˜¯åœ¨åå°è¿›è¡Œæ›´æ–°ï¼ŒWIP-Treeæ›´æ–°å®Œæˆåä¼šå¤åˆ¶å…¶å®ƒèŠ‚ç‚¹ï¼Œå¹¶æœ€ç»ˆæ›¿æ¢æ‰Current Treeï¼Œæˆä¸ºæ–°çš„Current Treeã€‚å› ä¸ºReactåœ¨æ›´æ–°æ—¶æ€»æ˜¯ç»´æŠ¤äº†ä¸¤ä¸ªFiberæ ‘ï¼Œæ‰€ä»¥å¯ä»¥éšæ—¶è¿›è¡Œæ¯”è¾ƒã€ä¸­æ–­æˆ–æ¢å¤ç­‰æ“ä½œï¼Œè€Œä¸”è¿™ç§æœºåˆ¶è®©Reactèƒ½å¤ŸåŒæ—¶å…·å¤‡æ‹¥æœ‰ä¼˜ç§€çš„æ¸²æŸ“æ€§èƒ½å’ŒUIçš„ç¨³å®šæ€§ã€‚
    
    ![2.png](/assets/035/2.png)
    
- **State å’Œ Props**ï¼š`memoizedProps`ã€**`pendingProps`** å’Œ **`memoizedState`** å­—æ®µè®©ReactçŸ¥é“ç»„ä»¶çš„ä¸Šä¸€ä¸ªçŠ¶æ€å’Œå³å°†åº”ç”¨çš„çŠ¶æ€ã€‚é€šè¿‡æ¯”è¾ƒè¿™äº›å€¼ï¼ŒReactå¯ä»¥å†³å®šç»„ä»¶æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œä»è€Œé¿å…ä¸å¿…è¦çš„æ¸²æŸ“ï¼Œæé«˜æ€§èƒ½ã€‚
- **å‰¯ä½œç”¨çš„è¿½è¸ª**ï¼š`flags` å’Œ **`subtreeFlags`** å­—æ®µæ ‡è¯†FiberåŠå…¶å­æ ‘ä¸­éœ€è¦æ‰§è¡Œçš„å‰¯ä½œç”¨ï¼Œä¾‹å¦‚DOMæ›´æ–°ã€ç”Ÿå‘½å‘¨æœŸæ–¹æ³•è°ƒç”¨ç­‰ã€‚Reactä¼šç§¯ç´¯è¿™äº›å‰¯ä½œç”¨ï¼Œç„¶ååœ¨Commité˜¶æ®µä¸€æ¬¡æ€§æ‰§è¡Œï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚

## Fiberå·¥ä½œæµç¨‹

äº†è§£äº†Fiberçš„å·¥ä½œåŸç†åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é˜…è¯»æºç æ¥åŠ æ·±å¯¹Fiberçš„ç†è§£ã€‚React Fiberçš„å·¥ä½œæµç¨‹ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

### ç¬¬ä¸€é˜¶æ®µï¼šReconciliationï¼ˆè°ƒå’Œï¼‰

- **ç›®æ ‡**: ç¡®å®šå“ªäº›éƒ¨åˆ†çš„UIéœ€è¦æ›´æ–°ã€‚
- **åŸç†**: è¿™æ˜¯Reactæ„å»ºå·¥ä½œè¿›åº¦æ ‘çš„é˜¶æ®µï¼Œä¼šæ¯”è¾ƒæ–°çš„propså’Œæ—§çš„Fiberæ ‘æ¥ç¡®å®šå“ªäº›éƒ¨åˆ†éœ€è¦æ›´æ–°ã€‚

è°ƒå’Œé˜¶æ®µåˆåˆ†ä¸ºä¸‰ä¸ªå°é˜¶æ®µï¼š

#### 1ã€åˆ›å»ºä¸æ ‡è®°æ›´æ–°èŠ‚ç‚¹ï¼š`beginWork`

1. **åˆ¤æ–­FiberèŠ‚ç‚¹æ˜¯å¦è¦æ›´æ–°**ï¼š

```tsx
// packages/react-reconciler/src/ReactFiberBeginWork.js
// ä»¥ä¸‹åªæ˜¯æ ¸å¿ƒé€»è¾‘çš„ä»£ç ï¼Œä¸æ˜¯beginWorkçš„å®Œæ•´æºç 
function beginWork(
  current: Fiber | null,
  workInProgress: Fiber,
  renderLanes: Lanes,
): Fiber | null {
	if (current !== null) {
		// è¿™æ˜¯æ—§èŠ‚ç‚¹ï¼Œéœ€è¦æ£€æŸ¥propså’Œcontextæ˜¯å¦æœ‰å˜åŒ–å†ç¡®è®¤æ˜¯å¦éœ€è¦æ›´æ–°èŠ‚ç‚¹
		const oldProps = current.memoizedProps;
    const newProps = workInProgress.pendingProps;

		if(oldProps !== newProps || hasLegacyContextChanged()) {
			didReceiveUpdate = true; // propså’Œcontextæœ‰å˜åŒ–ï¼Œè¯´æ˜èŠ‚ç‚¹æœ‰æ›´æ–°
		} else {
			// å…¶å®ƒç‰¹æ®Šæƒ…å†µçš„åˆ¤æ–­
		}
	} else {
		didReceiveUpdate = false; // è¿™æ˜¯æ–°èŠ‚ç‚¹ï¼Œè¦åˆ›å»ºï¼Œè€Œä¸æ˜¯æ›´æ–°
	}

	workInProgress.lanes = NoLanes; // è¿›å…¥beginWorkè¡¨ç¤ºå¼€å§‹æ–°çš„å·¥ä½œé˜¶æ®µï¼Œæ‰€ä»¥è¦æŠŠæ—§çš„workInProgressä¼˜å…ˆçº§æ¸…é™¤æ‰

	switch (workInProgress.tag) {
		// é€šè¿‡workInProgressçš„tagå±æ€§æ¥ç¡®å®šå¦‚ä½•å¤„ç†å½“å‰çš„FiberèŠ‚ç‚¹
		// æ¯ä¸€ç§tagå¯¹åº”ä¸€ç§ä¸åŒçš„Fiberç±»å‹ï¼Œè¿›å…¥ä¸åŒçš„è°ƒå’Œè¿‡ç¨‹ï¼ˆreconcileChildren()ï¼‰
		case IndeterminateComponent: // å°šæœªç¡®å®šå…¶ç±»å‹çš„ç»„ä»¶
		// â€¦â€¦
		case LazyComponent: // æ‡’åŠ è½½ç»„ä»¶
		// â€¦â€¦
		case FunctionComponent: // å‡½æ•°ç»„ä»¶
		// â€¦â€¦
		case ClassComponent: // ç±»ç»„ä»¶
		// â€¦â€¦
		
		// å…¶å®ƒå¤šç§Fiberç±»å‹
		// case â€¦â€¦
	}
}
```

1. **åˆ¤æ–­Fiberå­èŠ‚ç‚¹æ˜¯æ›´æ–°è¿˜æ˜¯å¤ç”¨ï¼š**

```tsx
// packages/react-reconciler/src/ReactFiberBeginWork.js
export function reconcileChildren(
  current: Fiber | null,
  workInProgress: Fiber,
  nextChildren: any, // è¦è°ƒå’Œçš„æ–°çš„å­å…ƒç´ 
  renderLanes: Lanes,
) {
  if (current === null) {
		// å¦‚æœcurrentä¸ºç©ºï¼Œè¯´æ˜è¿™ä¸ªFiberæ˜¯é¦–æ¬¡æ¸²æŸ“ï¼ŒReactä¼šä¸ºnextChildrenç”Ÿæˆä¸€ç»„æ–°çš„FiberèŠ‚ç‚¹
    workInProgress.child = mountChildFibers(
      workInProgress,
      null,
      nextChildren,
      renderLanes,
    );
  } else {
		// å½“currentéç©ºæ—¶ï¼ŒReactä¼šåˆ©ç”¨ç°æœ‰çš„FiberèŠ‚ç‚¹ï¼ˆcurrent.childï¼‰å’Œæ–°çš„å­å…ƒç´ ï¼ˆnextChildrenï¼‰è¿›è¡Œè°ƒå’Œ
    workInProgress.child = reconcileChildFibers(
      workInProgress,
      current.child,
      nextChildren,
      renderLanes,
    );
  }
}
```

**`mountChildFibers`** å’Œ **`reconcileChildFibers`** æœ€ç»ˆä¼šè¿›å…¥åŒä¸€ä¸ªæ–¹æ³• **`createChildReconciler`**ï¼Œæ‰§è¡Œ Fiber èŠ‚ç‚¹çš„è°ƒå’Œï¼ˆå¤„ç†è¯¸å¦‚æ–°çš„ Fiber åˆ›å»ºã€æ—§ Fiber åˆ é™¤æˆ–ç°æœ‰ Fiber æ›´æ–°ç­‰æ“ä½œï¼‰ã€‚è€Œæ•´ä¸ª **`beginWork`** å®Œæˆåï¼Œå°±ä¼šè¿›å…¥ **`completeWork`** æµç¨‹ã€‚

#### 2ã€æ”¶é›†å‰¯ä½œç”¨åˆ—è¡¨ï¼š`completeUnitOfWork`å’Œ`completeWork`

**`completeUnitOfWork`** è´Ÿè´£éå†FiberèŠ‚ç‚¹ï¼ŒåŒæ—¶è®°å½•äº†æœ‰å‰¯ä½œç”¨èŠ‚ç‚¹çš„å…³ç³»ã€‚ä¸‹é¢ä»æºç ä¸Šç†è§£å®ƒçš„å·¥ä½œï¼š

```tsx
// packages/react-reconciler/src/ReactFiberWorkLoop.js
// ä»¥ä¸‹åªæ˜¯æ ¸å¿ƒé€»è¾‘çš„ä»£ç ï¼Œä¸æ˜¯completeUnitOfWorkçš„å®Œæ•´æºç 
function completeUnitOfWork(unitOfWork: Fiber): void {
	let completedWork: Fiber = unitOfWork; // å½“å‰æ­£åœ¨å®Œæˆçš„å·¥ä½œå•å…ƒ
	do {
		const current = completedWork.alternate; // å½“å‰FiberèŠ‚ç‚¹åœ¨å¦ä¸€æ£µæ ‘ä¸Šçš„ç‰ˆæœ¬
		const returnFiber = completedWork.return; // å½“å‰FiberèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹

		let next;
    next = completeWork(current, completedWork, renderLanes); // è°ƒç”¨completeWorkå‡½æ•°

		if (next !== null) {
			// å½“å‰Fiberè¿˜æœ‰å·¥ä½œè¦å®Œæˆ
		  workInProgress = next;
		  return;
		}
		const siblingFiber = completedWork.sibling;
    if (siblingFiber !== null) {
			// å¦‚æœæœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œåˆ™è¿›å…¥å…„å¼ŸèŠ‚ç‚¹çš„å·¥ä½œ
      workInProgress = siblingFiber;
      return;
    }
    // å¦‚æœæ²¡æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œå›åˆ°çˆ¶èŠ‚ç‚¹ç»§ç»­
    completedWork = returnFiber;
    workInProgress = completedWork;
	} while (completedWork !== null);

	// å¦‚æœå¤„ç†äº†æ•´ä¸ªFiberæ ‘ï¼Œæ›´æ–°workInProgressRootExitStatusä¸ºRootCompletedï¼Œè¡¨ç¤ºè°ƒå’Œå·²å®Œæˆ
  if (workInProgressRootExitStatus === RootInProgress) {
    workInProgressRootExitStatus = RootCompleted;
  } 
}
```

**`completeWork`** åœ¨ **`completeUnitOfWork`** ä¸­è¢«è°ƒç”¨ï¼Œä¸‹é¢æ˜¯ **`completeWork`** çš„é€»è¾‘ï¼Œä¸»è¦æ˜¯æ ¹æ® tag è¿›è¡Œä¸åŒçš„å¤„ç†ï¼ŒçœŸæ­£çš„æ ¸å¿ƒé€»è¾‘åœ¨ **`bubbleProperties`** é‡Œé¢

```tsx
// packages/react-reconciler/src/ReactFiberCompleteWork.js
// ä»¥ä¸‹åªæ˜¯æ ¸å¿ƒé€»è¾‘çš„ä»£ç ï¼Œä¸æ˜¯completeWorkçš„å®Œæ•´æºç 
function completeWork(
  current: Fiber | null,
  workInProgress: Fiber,
  renderLanes: Lanes,
): Fiber | null {
  const newProps = workInProgress.pendingProps;
	switch (workInProgress.tag) {
    // å¤šç§tag
    case FunctionComponent:
    case ForwardRef:
    case SimpleMemoComponent:
			 bubbleProperties(workInProgress)
      return null;
    case ClassComponent:
			 // çœç•¥é€»è¾‘
      // â€¦â€¦
			 bubbleProperties(workInProgress)
      return null;
    case HostComponent:
			 // çœç•¥é€»è¾‘
      // â€¦â€¦
      return null;
    // å¤šç§tag
		// â€¦â€¦
  }
}
```

**`bubbleProperties`** ä¸º **`completeWork`** å®Œæˆäº†ä¸¤ä¸ªå·¥ä½œï¼š

1. **è®°å½•Fiberçš„å‰¯ä½œç”¨æ ‡å¿—**
2. **ä¸ºå­Fiberåˆ›å»ºé“¾è¡¨**

è¿™ä¸¤ä¸ªå·¥ä½œéƒ½ä»ä¸‹é¢è¿™æ®µä»£ç ä¸­çœ‹å‡ºæ¥ï¼š

```tsx
// packages/react-reconciler/src/ReactFiberCompleteWork.js
// ä»¥ä¸‹åªæ˜¯æ ¸å¿ƒé€»è¾‘çš„ä»£ç ï¼Œä¸æ˜¯bubblePropertiesçš„å®Œæ•´æºç 
function bubbleProperties(completedWork: Fiber) {
	const didBailout =
    completedWork.alternate !== null &&
    completedWork.alternate.child === completedWork.child; // å½“å‰çš„Fiberä¸å…¶alternateï¼ˆå¤‡ç”¨/ä¸Šä¸€æ¬¡çš„Fiberï¼‰æœ‰ç›¸åŒçš„å­èŠ‚ç‚¹ï¼Œåˆ™è·³è¿‡æ›´æ–°

  let newChildLanes = NoLanes; // åˆå¹¶åçš„å­Fiberçš„lanes
  let subtreeFlags = NoFlags; // å­æ ‘çš„flagsã€‚

	if (!didBailout) {
		// æ²¡æœ‰bailoutï¼Œéœ€è¦å†’æ³¡å­Fiberçš„å±æ€§åˆ°çˆ¶Fiber
		let child = completedWork.child;
		// éå†å­Fiberï¼Œå¹¶åˆå¹¶å®ƒä»¬çš„laneså’Œflags
    while (child !== null) {
      newChildLanes = mergeLanes(
        newChildLanes,
        mergeLanes(child.lanes, child.childLanes),
      );

      subtreeFlags |= child.subtreeFlags;
      subtreeFlags |= child.flags;

      child.return = completedWork; // Fiberçš„returnæŒ‡å‘çˆ¶Fiberï¼Œç¡®ä¿æ•´ä¸ªFiberæ ‘çš„ä¸€è‡´æ€§
      child = child.sibling;
    }
		completedWork.subtreeFlags |= subtreeFlags; // åˆå¹¶æ‰€æœ‰flagsï¼ˆå‰¯ä½œç”¨ï¼‰
	} else {
		// æœ‰bailoutï¼Œåªå†’æ³¡é‚£äº›å…·æœ‰â€œé™æ€â€ç”Ÿå‘½å‘¨æœŸçš„flags
		let child = completedWork.child;
    while (child !== null) {
      newChildLanes = mergeLanes(
        newChildLanes,
        mergeLanes(child.lanes, child.childLanes),
      );

      subtreeFlags |= child.subtreeFlags & StaticMask; // ä¸åŒ
      subtreeFlags |= child.flags & StaticMask; // ä¸åŒ

      child.return = completedWork;
      child = child.sibling;
    }
		completedWork.subtreeFlags |= subtreeFlags;
	}
	completedWork.childLanes = newChildLanes; // è·å–æ‰€æœ‰å­Fiberçš„lanesã€‚

	return didBailout;
}
```

#### è°ƒå’Œé˜¶æ®µçŸ¥è¯†æ‹“å±•

**1ã€ä¸ºä»€ä¹ˆFiberæ¶æ„æ›´å¿«ï¼Ÿ**

åœ¨ä¸Šé¢è¿™æ®µä»£ç é‡Œï¼Œæˆ‘ä»¬è¿˜å¯ä»¥çœ‹å‡ºæ¥ä¸ºä»€ä¹ˆFiberæ¶æ„æ¯”ä»¥å‰çš„é€’å½’DOMè®¡ç®—è¦å¿«ï¼š**`flags`** æˆ– **`subtreeFlags`** æ˜¯16è¿›åˆ¶çš„æ ‡è¯†ï¼Œåœ¨è¿™é‡Œè¿›è¡ŒæŒ‰ä½æˆ–(`|`)è¿ç®—åï¼Œå¯ä»¥è®°å½•å½“å‰èŠ‚ç‚¹æœ¬èº«å’Œå­æ ‘çš„å‰¯ä½œç”¨ç±»å‹ï¼Œé€šè¿‡è¿™ä¸ªè¿ç®—ç»“æœå¯ä»¥å‡å°‘èŠ‚ç‚¹çš„éå†ï¼Œä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­è¯´æ˜ï¼š

```tsx
å‡è®¾æœ‰ä¸¤ç§æ ‡è¯†ç¬¦ï¼š
Placement (è¡¨ç¤ºæ–°æ’å…¥çš„å­èŠ‚ç‚¹)ï¼š0b001
Update (è¡¨ç¤ºå­èŠ‚ç‚¹å·²æ›´æ–°)ï¼š0b010

A
â”œâ”€ B (Update)
â”‚   â””â”€ D (Placement)
â””â”€ C
   â””â”€ E

è¿™ä¸ªä¾‹å­é‡Œï¼Œè®¡ç®—é€»è¾‘æ˜¯è¿™æ ·ï¼š
1ã€æ£€æŸ¥åˆ°Açš„flagsæ²¡æœ‰å‰¯ä½œç”¨ï¼Œç›´æ¥å¤ç”¨ï¼Œä½†subtreeFlagsæœ‰å‰¯ä½œç”¨ï¼Œé‚£ä¹ˆé€’å½’æ£€æŸ¥Bå’ŒC
2ã€æ£€æŸ¥åˆ°Bçš„flagsæœ‰å¤ç”¨ï¼Œæ›´æ–°Bï¼ŒsubtreeFlagsä¹Ÿæœ‰å‰¯ä½œç”¨ï¼Œåˆ™ç»§ç»­æ£€æŸ¥D
3ã€æ£€æŸ¥åˆ°Cçš„flagsæ²¡æœ‰å‰¯ä½œç”¨ï¼ŒsubtreeFlagsä¹Ÿæ²¡æœ‰å‰¯ä½œç”¨ï¼Œé‚£ä¹ˆç›´æ¥å¤ç”¨Cå’ŒE
å¦‚æœèŠ‚ç‚¹æ›´å¤šï¼Œåˆ™ä»¥æ­¤ç±»æ¨ã€‚
è¿™æ ·çš„è®¡ç®—æ–¹å¼å¯ä»¥å‡å°‘é€’å½’é‚£äº›æ²¡æœ‰å‰¯ä½œç”¨çš„å­æ ‘æˆ–èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ¯”ä»¥å‰çš„ç‰ˆæœ¬å…¨éƒ¨é€’å½’çš„ç®—æ³•è¦é«˜æ•ˆ
```

**2ã€è°ƒå’Œè¿‡ç¨‹å¯ä¸­æ–­**

å‰é¢æˆ‘ä»¬æåˆ°ï¼Œè°ƒå’Œè¿‡ç¨‹å¯ä»¥è¢«ä¸­æ–­ï¼Œç°åœ¨æˆ‘ä»¬å°±çœ‹çœ‹æºç é‡Œæ˜¯æ€ä¹ˆè¿›è¡Œä¸­æ–­å’Œæ¢å¤çš„ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ˜ç¡®å¯ä¸­æ–­çš„èƒ½åŠ›æ˜¯Reactå¹¶å‘æ¨¡å¼ï¼ˆConcurrent Modeï¼‰çš„æ ¸å¿ƒï¼Œè¿™ç§èƒ½åŠ›ä½¿å¾—Reactå¯ä»¥ä¼˜å…ˆå¤„ç†é«˜ä¼˜å…ˆçº§çš„æ›´æ–°ï¼Œè€Œæ¨è¿Ÿä½ä¼˜å…ˆçº§çš„æ›´æ–°ã€‚

å¯ä»¥ä»ä¸‹é¢è¿™æ®µä»£ç ç†è§£ä¸­æ–­ä¸æ¢å¤çš„å¤„ç†é€»è¾‘ï¼š

```tsx
// packages/react-reconciler/src/ReactFiberWorkLoop.js
// ä»¥ä¸‹åªæ˜¯æ ¸å¿ƒé€»è¾‘çš„ä»£ç ï¼Œä¸æ˜¯renderRootConcurrentçš„å®Œæ•´æºç 
function renderRootConcurrent(root: FiberRoot, lanes: Lanes) {
	// ä¿å­˜å½“å‰çš„æ‰§è¡Œä¸Šä¸‹æ–‡å’Œ dispatcher
	const prevExecutionContext = executionContext;
  executionContext |= RenderContext;
  const prevDispatcher = pushDispatcher(root.containerInfo);
  const prevCacheDispatcher = pushCacheDispatcher();

	if (workInProgressRoot !== root || workInProgressRootRenderLanes !== lanes) {
		// å¦‚æœå½“å‰çš„å·¥ä½œè¿›åº¦æ ‘ä¸ä¼ å…¥çš„ root æˆ– lanes ä¸åŒ¹é…ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ–°çš„æ¸²æŸ“ä»»åŠ¡å‡†å¤‡ä¸€ä¸ªæ–°çš„å †æ ˆã€‚
		// â€¦â€¦
	}

	// æŒç»­çš„å·¥ä½œå¾ªç¯ï¼Œé™¤éä¸­æ–­å‘ç”Ÿï¼Œå¦åˆ™ä¼šä¸€ç›´å°è¯•å®Œæˆæ¸²æŸ“å·¥ä½œ
	outer: do {
    try {
      if (
        workInProgressSuspendedReason !== NotSuspended &&
        workInProgress !== null
      ) {
        // å¦‚æœå½“å‰çš„å·¥ä½œè¿›åº¦æ˜¯ç”±äºæŸç§åŸå› è€Œè¢«æŒ‚èµ·çš„ï¼Œå¹¶ä¸”ä»ç„¶æœ‰å·¥ä½œå¾…å¤„ç†ï¼Œé‚£ä¹ˆä¼šå¤„ç†å®ƒ
        const unitOfWork = workInProgress;
        const thrownValue = workInProgressThrownValue;

				 // æ ¹æ®ä¸åŒæŒ‚èµ·åŸå› ï¼Œè¿›è¡Œä¸­æ–­ã€æ¢å¤ç­‰è®¡ç®—
        resumeOrUnwind: switch (workInProgressSuspendedReason) {
          case SuspendedOnError: {
            // å¦‚æœå·¥ä½œå› é”™è¯¯è¢«æŒ‚èµ·ï¼Œé‚£ä¹ˆå·¥ä½œä¼šè¢«ä¸­æ–­ï¼Œå¹¶ä»æœ€åä¸€ä¸ªå·²çŸ¥çš„ç¨³å®šç‚¹ç»§ç»­
						 // â€¦â€¦çœç•¥é€»è¾‘
            break;
          }
          case SuspendedOnData: {
            // å·¥ä½œå› ç­‰å¾…æ•°æ®ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚çš„ç»“æœï¼‰è€Œè¢«æŒ‚èµ·ï¼Œ
						 // â€¦â€¦çœç•¥é€»è¾‘
            break outer;
          }
					 case SuspendedOnInstance: {
						 // å°†æŒ‚èµ·çš„åŸå› æ›´æ–°ä¸ºSuspendedOnInstanceAndReadyToContinueå¹¶ä¸­æ–­å·¥ä½œå¾ªç¯ï¼Œæ ‡è®°ä¸ºç¨åå‡†å¤‡å¥½ç»§ç»­æ‰§è¡Œ
            workInProgressSuspendedReason =
              SuspendedOnInstanceAndReadyToContinue;
            break outer;
          }
          case SuspendedAndReadyToContinue: {
						 // è¡¨ç¤ºä¹‹å‰çš„æŒ‚èµ·å·¥ä½œç°åœ¨å·²ç»å‡†å¤‡å¥½ç»§ç»­æ‰§è¡Œ
							 if (isThenableResolved(thenable)) {
              // å¦‚æœå·²è§£æï¼Œè¿™æ„å‘³ç€éœ€è¦çš„æ•°æ®ç°åœ¨å·²ç»å¯ç”¨
              workInProgressSuspendedReason = NotSuspended;
              workInProgressThrownValue = null;
              replaySuspendedUnitOfWork(unitOfWork); // æ¢å¤æ‰§è¡Œè¢«æŒ‚èµ·çš„å·¥ä½œ
            } else {
              workInProgressSuspendedReason = NotSuspended;
              workInProgressThrownValue = null;
              throwAndUnwindWorkLoop(unitOfWork, thrownValue); // ç»§ç»­å¾ªç¯
            }
            break;
          }
  				 case SuspendedOnInstanceAndReadyToContinue: {
						 // â€¦â€¦çœç•¥éƒ¨åˆ†é€»è¾‘
						 const isReady = preloadInstance(type, props);
						 if (isReady) {
							  // å®ä¾‹å·²ç»å‡†å¤‡å¥½
              workInProgressSuspendedReason = NotSuspended; // è¯¥fiberå·²å®Œæˆï¼Œä¸éœ€è¦å†æŒ‚èµ·
              workInProgressThrownValue = null;
              const sibling = hostFiber.sibling;
              if (sibling !== null) {
                workInProgress = sibling; // æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œå¼€å§‹å¤„ç†å…„å¼ŸèŠ‚ç‚¹
              } else {
									// æ²¡æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œå›åˆ°çˆ¶èŠ‚ç‚¹
                const returnFiber = hostFiber.return;
                if (returnFiber !== null) {
                  workInProgress = returnFiber;
                  completeUnitOfWork(returnFiber); // æ”¶é›†å‰¯ä½œç”¨ï¼Œå‰é¢æœ‰è¯¦ç»†ä»‹ç»
                } else {
                  workInProgress = null;
                }
              }
              break resumeOrUnwind;
            }
					 }
					 // è¿˜æœ‰å…¶å®ƒcase
        }
      }

      workLoopConcurrent(); // å¦‚æœæ²¡æœ‰ä»»ä½•å·¥ä½œè¢«æŒ‚èµ·ï¼Œé‚£ä¹ˆå°±ä¼šç»§ç»­å¤„ç†å·¥ä½œå¾ªç¯ã€‚
      break;
    } catch (thrownValue) {
      handleThrow(root, thrownValue);
    }
  } while (true);

	// é‡ç½®äº†ä¹‹å‰ä¿å­˜çš„æ‰§è¡Œä¸Šä¸‹æ–‡å’Œdispatcherï¼Œç¡®ä¿åç»­çš„ä»£ç ä¸ä¼šå—åˆ°è¿™ä¸ªå‡½æ•°çš„å½±å“
  resetContextDependencies();
	popDispatcher(prevDispatcher);
  popCacheDispatcher(prevCacheDispatcher);
  executionContext = prevExecutionContext;

	// æ£€æŸ¥è°ƒå’Œæ˜¯å¦å·²å®Œæˆ
	if (workInProgress !== null) {
		// æœªå®Œæˆ
		return RootInProgress; // è¿”å›ä¸€ä¸ªçŠ¶æ€å€¼ï¼Œè¡¨ç¤ºè¿˜æœ‰æœªå®Œæˆ
	} else {
		// å·²å®Œæˆ
		workInProgressRoot = null; // é‡ç½®root
    workInProgressRootRenderLanes = NoLanes; // é‡ç½®Lane
    finishQueueingConcurrentUpdates(); // å¤„ç†é˜Ÿåˆ—ä¸­çš„å¹¶å‘æ›´æ–°
    return workInProgressRootExitStatus; // è¿”å›å½“å‰æ¸²æŸ“rootçš„æœ€ç»ˆé€€å‡ºçŠ¶æ€
	}
}
```

### ç¬¬äºŒé˜¶æ®µï¼šCommitï¼ˆæäº¤ï¼‰

- **ç›®æ ‡**: æ›´æ–°DOMå¹¶æ‰§è¡Œä»»ä½•å‰¯ä½œç”¨ã€‚
- **åŸç†**: éå†åœ¨Reconciliationé˜¶æ®µåˆ›å»ºçš„å‰¯ä½œç”¨åˆ—è¡¨è¿›è¡Œæ›´æ–°ã€‚

æºç é‡Œ **`commitRoot`** å’Œ **`commitRootImpl`** æ˜¯æäº¤é˜¶æ®µçš„å…¥å£æ–¹æ³•ï¼Œåœ¨ä¸¤ä¸ªæ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹å‡ºæ¥æäº¤é˜¶æ®µä¹Ÿæœ‰ä¸‰ä¸ªæ ¸å¿ƒå°é˜¶æ®µï¼Œæˆ‘ä»¬ä¸€ä¸€è®²è§£ï¼š

#### 1ã€éå†å‰¯ä½œç”¨åˆ—è¡¨ï¼š`BeforeMutation`

```tsx
// packages/react-reconciler/src/ReactFiberCommitWork.js
// ä»¥ä¸‹åªæ˜¯æ ¸å¿ƒé€»è¾‘çš„ä»£ç ï¼Œä¸æ˜¯commitBeforeMutationEffectsçš„å®Œæ•´æºç 
export function commitBeforeMutationEffects(
  root: FiberRoot,
  firstChild: Fiber,
): boolean {
  nextEffect = firstChild; // nextEffectæ˜¯éå†æ­¤é“¾è¡¨æ—¶çš„å½“å‰fiber
  commitBeforeMutationEffects_begin(); // éå†fiberï¼Œå¤„ç†èŠ‚ç‚¹åˆ é™¤å’Œç¡®è®¤èŠ‚ç‚¹åœ¨before mutationé˜¶æ®µæ˜¯å¦æœ‰è¦å¤„ç†çš„å‰¯ä½œç”¨

  const shouldFire = shouldFireAfterActiveInstanceBlur; // å½“ä¸€ä¸ªç„¦ç‚¹å…ƒç´ è¢«åˆ é™¤æˆ–éšè—æ—¶ï¼Œå®ƒä¼šè¢«è®¾ç½®ä¸º true
  shouldFireAfterActiveInstanceBlur = false;
  focusedInstanceHandle = null;

  return shouldFire;
}
```

#### 2ã€æ­£å¼æäº¤ï¼š`CommitMutation`

```tsx
// packages/react-reconciler/src/ReactFiberCommitWork.js
// ä»¥ä¸‹åªæ˜¯æ ¸å¿ƒé€»è¾‘çš„ä»£ç ï¼Œä¸æ˜¯commitMutationEffectsçš„å®Œæ•´æºç 
export function commitMutationEffects(
  root: FiberRoot,
  finishedWork: Fiber,
  committedLanes: Lanes,
) {
	// laneså’Œrootè¢«è®¾ç½®ä¸º"in progress"çŠ¶æ€ï¼Œè¡¨ç¤ºå®ƒä»¬æ­£åœ¨è¢«å¤„ç†
  inProgressLanes = committedLanes;
  inProgressRoot = root;

	// é€’å½’éå†Fiberï¼Œæ›´æ–°å‰¯ä½œç”¨èŠ‚ç‚¹
  commitMutationEffectsOnFiber(finishedWork, root, committedLanes);

	// é‡ç½®è¿›è¡Œä¸­çš„laneså’Œroot
  inProgressLanes = null;
  inProgressRoot = null;
}
```

#### 3ã€å¤„ç†layout effectsï¼š`commitLayout`

```tsx
// packages/react-reconciler/src/ReactFiberCommitWork.js
export function commitLayoutEffects(
  finishedWork: Fiber,
  root: FiberRoot,
  committedLanes: Lanes,
): void {
  inProgressLanes = committedLanes;
  inProgressRoot = root;

	// åˆ›å»ºä¸€ä¸ªcurrentæŒ‡å‘å°±Fiberæ ‘çš„alternate
  const current = finishedWork.alternate;
	// å¤„ç†é‚£äº›ç”±useLayoutEffectåˆ›å»ºçš„layout effects
  commitLayoutEffectOnFiber(root, current, finishedWork, committedLanes);

  inProgressLanes = null;
  inProgressRoot = null;
}
```

ä»æºç é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸€æ—¦è¿›å…¥æäº¤é˜¶æ®µåï¼ŒReactæ˜¯æ— æ³•ä¸­æ–­çš„ã€‚

## ç»“è¯­

ä»¥ä¸Šå†…å®¹è™½æ— æ³•è¦†ç›–Fiberçš„æ–¹æ–¹é¢é¢ï¼Œä½†å¯ä»¥ç¡®ä¿ä½ å­¦å®Œåå¯¹Fiberä¼šæœ‰ä¸€ä¸ªæ•´ä½“ä¸Šçš„è®¤è¯†ï¼Œå¹¶ä¸”è®©ä½ åœ¨ä»¥åé˜…è¯»äº’è”ç½‘ä¸Šå…¶å®ƒå…³äºFiberæ¶æ„çš„æ–‡ç« æ—¶ï¼Œä¸å†å› ä¸ºåŸºç¡€çŸ¥è¯†å›°æƒ‘ï¼Œè€Œæ˜¯èƒ½å¤Ÿæ ¹æ®å·²æœ‰çš„æ€è·¯è½»æ¾åœ°æ‹“å±•ä½ å¤§è„‘é‡Œå…³äºFiberæ¶æ„çš„çŸ¥è¯†ç½‘ã€‚