---
title: ä½¿ç”¨ CloudFlare å’Œ Resend å¿«é€Ÿå®ç°ç½‘ç«™é‚®ä»¶è®¢é˜…ï¼ˆnewsletterï¼‰åŠŸèƒ½
description: æœ¬æ•™ç¨‹è¯¦ç»†ä»‹ç»å¦‚ä½•åˆ©ç”¨CloudFlareå’ŒResend APIåœ¨Next.jsé¡¹ç›®ä¸­å®ç°å®Œæ•´çš„é‚®ä»¶è®¢é˜…(Newsletter)åŠŸèƒ½ï¼ŒåŒ…å«åŸŸåé…ç½®ã€APIæ¥å…¥ã€å‰ç«¯è¡¨å•å’Œé€€è®¢æµç¨‹çš„å…¨éƒ¨æ­¥éª¤ï¼Œ10åˆ†é’Ÿå³å¯å®Œæˆéƒ¨ç½²ã€‚
slug: implement-newsletter-with-cloudflare-and-resend
tags: NextJS,NextJSå®æˆ˜,Resend
date: 2025-03-20
---

çœ‹å¤šäº†è‹±æ–‡ç½‘ç«™ï¼Œä½ ä¼šå‘ç°å¤§å¤šæ•°ç½‘ç«™éƒ½æä¾›äº† newsletter è®¢é˜…åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯é‚®ä»¶è®¢é˜…ã€‚å› ä¸ºå› ä¸ºæµ·å¤–ç”¨æˆ·å…¶å®éƒ½è¿˜ä¹ æƒ¯æŸ¥çœ‹é‚®ç®±ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬çš„ç½‘ç«™æœ‰é‚®ä»¶è®¢é˜…åŠŸèƒ½ï¼Œåªè¦æœ‰ç”¨æˆ·è®¢é˜…äº†é‚®ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¦»ç”¨æˆ·æ›´è¿‘ä¸€äº›ã€‚

å½“æˆ‘çŸ¥é“åˆ©ç”¨ CloudFlare å’Œ Resend å¯ä»¥ä½æˆæœ¬å¼€å‘é‚®ä»¶è®¢é˜…åŠŸèƒ½çš„æ—¶å€™ï¼Œæˆ‘å°±å†³å®šç»™æˆ‘çš„è‡ªç”¨[Next.js æ¨¡æ¿](https://nextforge.dev/)è¡¥å……ä¸€ä¸‹è¿™ä¸ªåŠŸèƒ½ã€‚

æ ¹æ®æœ¬æ–‡çš„æ­¥éª¤ï¼Œä½ å¯ä»¥10åˆ†é’Ÿå®Œæˆæ•´ä¸ªæ¥å…¥æµç¨‹ã€‚ä¸è¿‡éœ€è¦æé†’çš„æ˜¯ï¼Œæœ¬æ–‡æ•™å­¦çš„æ˜¯æ¥å…¥çš„åŸºç¡€æ­¥éª¤ï¼Œå¦‚æœä½ çš„äº§å“ç”¨æˆ·é‡å¤§ã€å®‰å…¨éœ€æ±‚é«˜ï¼Œä½ éœ€è¦åœ¨æ­¤åŸºç¡€ä¸Šï¼Œç»“åˆè‡ªå·±çš„ä¸šåŠ¡æ·»åŠ é¢å¤–çš„é˜²èŒƒæªæ–½ï¼Œè¿™ä¸€ç‚¹ä¹Ÿä¼šåœ¨æ–‡æœ«æå‡ºä¸€ç‚¹æˆ‘çš„çœ‹æ³•ã€‚

## ä»€ä¹ˆæ˜¯ CloudFlare ä»¥åŠä½¿ç”¨æ­¥éª¤

Cloudflare æ˜¯ä¸€å®¶æä¾›å†…å®¹åˆ†å‘ç½‘ç»œ(CDN)ã€DDoS é˜²æŠ¤ã€å®‰å…¨æœåŠ¡å’Œè¾¹ç¼˜è®¡ç®—è§£å†³æ–¹æ¡ˆçš„å…¨çƒæ€§å…¬å¸ï¼Œå¸®åŠ©ç½‘ç«™æé«˜æ€§èƒ½ã€å®‰å…¨æ€§å’Œå¯é æ€§ã€‚å› ä¸ºå…¶æ…·æ…¨çš„å…è´¹æœåŠ¡è€Œè¢«ç§°ä¸ºâ€œèµ›åšè©è¨â€ã€‚

æœ¬æ–‡çš„æµç¨‹é‡Œï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦æŠŠåŸŸåæ”¾åœ¨ CloudFlare è§£æ

![cloudflare dns](/assets/067/1.webp)

ç„¶åæ‰“å¼€é‚®ä»¶åŠŸèƒ½

![cloudflare email](/assets/067/2.webp)

åˆ›å»ºé‚®ç®±è½¬å‘

![cloudflare email](/assets/067/3.webp)

ç»§ç»­

![cloudflare email](/assets/067/4.webp)

æ ¹æ®æç¤ºè‡ªåŠ¨æ·»åŠ  DNS è®°å½•ï¼Œ

![cloudflare email](/assets/067/5.webp)

å®Œæˆåå¦‚å›¾

![cloudflare email](/assets/067/6.webp)

ç°åœ¨å‘é€åˆ° `hi@nextforge.dev` çš„é‚®ä»¶å°±ä¼šè¢« CloudFlare è½¬å‘åˆ°æˆ‘æŒ‡å®šçš„é‚®ç®±äº†ã€‚

## ä»€ä¹ˆæ˜¯ Resend ä»¥åŠä½¿ç”¨æ­¥éª¤

Resend æ˜¯ä¸€ä¸ªç°ä»£åŒ–çš„ç”µå­é‚®ä»¶ API å¹³å°ï¼Œä½¿å¼€å‘è€…èƒ½å¤Ÿè½»æ¾åœ°å°†é«˜è´¨é‡çš„ç”µå­é‚®ä»¶åŠŸèƒ½é›†æˆåˆ°åº”ç”¨ä¸­ï¼Œæä¾›å¯é çš„é‚®ä»¶å‘é€ã€è·Ÿè¸ªå’Œåˆ†ææœåŠ¡ã€‚

æ³¨å†Œåœ°å€ï¼šhttps://resend.com/

è¿™é‡Œè·³è¿‡æ³¨å†Œæ­¥éª¤ã€‚

è¿›å…¥ Resend åå°ï¼Œå…ˆæ·»åŠ åŸŸå

![resend domain](/assets/067/7.webp)

è¾“å…¥è¦æ·»åŠ çš„åŸŸååï¼Œç›´æ¥ç‚¹å‡»ã€ŒSign in to CloudFlareã€æŒ‰é’®ï¼Œä¼šè‡ªåŠ¨æ·»åŠ  DNS è®°å½•ã€‚

![resend domain](/assets/067/8.webp)

ç°åœ¨å‰3ä¸ªè®°å½•å·²ç»è‡ªåŠ¨æ·»åŠ äº†ï¼Œè¿˜éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ·»åŠ  `_dmarc` è®°å½•ã€‚

![resend domain](/assets/067/9.webp)

å›åˆ° CloudFlare DNSï¼Œæ·»åŠ  `_dmarc` è®°å½•ï¼Œå€¼ä¸º `v=DMARC1; p= quarantine;`

![cloudflare dns](/assets/067/10.webp)

å¦‚æœ Resend å¾ˆä¹…äº†è¿˜æ˜¯ç°å® pending çŠ¶æ€ï¼Œä¸è¦æ‹…å¿ƒï¼Œè¿™ä¸€æ­¥æ€»æ˜¯è¦ç­‰å¾ˆä¹…ï¼Œå…ˆç»§ç»­åšä¸‹é¢çš„æ­¥éª¤

![resend domain](/assets/067/11.webp)

å…ˆæ¥åˆ›å»º API Keyï¼Œæƒé™é€‰æ‹© Full Accessï¼Œåˆ›å»ºå®Œæˆåï¼Œå¤åˆ¶ä¸‹ API Key

![resend api key](/assets/067/12.webp)

![resend api key](/assets/067/13.webp)

å†æ‰“å¼€ Audienceï¼Œå¤åˆ¶ Audience ID

![resend api key](/assets/067/14.webp)

ç°åœ¨æ‰“å¼€é¡¹ç›®ï¼Œåœ¨ `.env` æ–‡ä»¶é‡Œæ·»åŠ  3 ä¸ªç¯å¢ƒå˜é‡

```.env
RESEND_API_KEY=
ADMIN_EMAIL=
RESEND_AUDIENCE_ID=
```

å…¶ä¸­ï¼ŒADMIN_EMAIL æ˜¯ä½ çš„ Resend è´¦æˆ·é‚®ç®±ã€‚

## ä»£ç å®ç°

æœ¬èŠ‚åªæä¾›å®ç°æ€è·¯ï¼Œå¹¶ç•™ä¸‹å®Œæ•´ä»£ç çš„ GitHub åœ°å€ï¼Œéœ€è¦å®Œæ•´ä»£ç å¯ä»¥è‡ªå–ã€‚

### å‰ç«¯è®¢é˜…è¡¨å•

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç”¨æˆ·å‹å¥½çš„è®¢é˜…è¡¨å•ã€‚ä»¥ä¸‹æ˜¯æ ¸å¿ƒå®ç°:

```ts
// components/footer/Newsletter.tsx
// å®Œæ•´ä»£ç åœ°å€ï¼šhttps://github.com/weijunext/nextjs-15-starter/blob/main/components/footer/Newsletter.tsx

"use client";

export function Newsletter() {
  // çŠ¶æ€ç®¡ç†ï¼šé‚®ç®±ã€è®¢é˜…çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯
  const [email, setEmail] = useState("");
  const [subscribeStatus, setSubscribeStatus] = useState("idle");
  const [errorMessage, setErrorMessage] = useState("");

  const handleSubscribe = async (e) => {
    try {
      // è®¾ç½®åŠ è½½çŠ¶æ€
      setSubscribeStatus("loading");
      
      // APIè°ƒç”¨å‘é€è®¢é˜…è¯·æ±‚
      const response = await fetch("/api/newsletter", {
        method: "POST",
        body: JSON.stringify({ email }),
        // è®¾ç½®headers...
      });

      // å¤„ç†å“åº”...

      // 5ç§’åé‡ç½®çŠ¶æ€...
    } catch (error) {
      // é”™è¯¯å¤„ç†...

      // 5ç§’åé‡ç½®çŠ¶æ€...
    }
  };

  return (
    <div>
      <form onSubmit={handleSubscribe}>
        <input
          type="email"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          disabled={subscribeStatus === "loading"}
        />
        <button disabled={subscribeStatus === "loading"}>
          {subscribeStatus === "loading" ? "è®¢é˜…ä¸­..." : "è®¢é˜…"}
        </button>
        
        {/* çŠ¶æ€åé¦ˆä¿¡æ¯ */}
        {subscribeStatus === "success" && <p>è®¢é˜…æˆåŠŸï¼</p>}
        {subscribeStatus === "error" && <p>{errorMessage}</p>}
      </form>
    </div>
  );
}
```

è¿™ä¸ªç»„ä»¶éœ€è¦å®ç°ï¼š
- é‚®ç®±è¾“å…¥å’Œæäº¤
- è®¢é˜…æˆåŠŸæˆ–è€…å¤±è´¥çš„çŠ¶æ€æç¤º
- æç¤ºè¯­å¯è‡ªåŠ¨å…³é—­

### é‚®ç®±éªŒè¯

ä¸ºäº†ç¡®ä¿é‚®ç®±åœ°å€çš„æœ‰æ•ˆæ€§ï¼Œæˆ‘å®ç°äº†ä¸¤ä¸ªå…³é”®å‡½æ•°ï¼š

```ts
// lib/email.ts
// å®Œæ•´ä»£ç åœ°å€ï¼šhttps://github.com/weijunext/nextjs-15-starter/blob/main/lib/email.ts

function validateEmail(email: string) {
  // éªŒè¯é‚®ç®±æ ¼å¼
  // æ£€æŸ¥åŸŸåé•¿åº¦
  // æ£€æŸ¥ä¸€æ¬¡æ€§é‚®ç®±
  // æ£€æŸ¥ç‰¹æ®Šå­—ç¬¦
}

function normalizeEmail(email: string) {
  // æ ‡å‡†åŒ–å¤„ç†
  // å¤„ç†åˆ«å (å¦‚ Gmail çš„ç‚¹å·å’ŒåŠ å·åç¼€)
}
```

è¿™ä¸¤ä¸ªæ–¹æ³•åˆ›å»ºäº†ä¸€äº›å¸¸è§çš„éªŒè¯ï¼Œä¾‹å¦‚é‚®ç®±æ ¼å¼ã€é˜²æ­¢ä¸€æ¬¡æ€§é‚®ç®±ã€å¤„ç†é‚®ç®±åˆ«åç­‰ï¼Œå¦‚æœä½ æœ‰æ›´å¤šæœ‰ç”¨çš„éªŒè¯æ–¹æ³•ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°è¿›è¡Œæ‰©å±•ã€‚

### API å®ç°

åœ¨æœåŠ¡å™¨ç«¯ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†è®¢é˜…è¯·æ±‚ï¼š

```ts
// app/api/newsletter/route.ts
// å®Œæ•´ä»£ç åœ°å€ï¼šhttps://github.com/weijunext/nextjs-15-starter/blob/main/app/api/newsletter/route.ts

import { normalizeEmail, validateEmail } from '@/lib/email';
import { headers } from 'next/headers';
import { NextResponse } from 'next/server';
import { Resend } from 'resend';

// åˆå§‹åŒ– Resend
const resend = new Resend(process.env.RESEND_API_KEY);
// Resend Audience ID
const AUDIENCE_ID = process.env.RESEND_AUDIENCE_ID!;

export async function POST(request: Request) {
  try {
    // å¤„ç†è¯·æ±‚æ•°æ®
    const { email } = await request.json();
    const normalizedEmail = normalizeEmail(email);

    // éªŒè¯é‚®ç®±â€¦â€¦

    // ç”Ÿæˆé€€è®¢ä»¤ç‰Œå’Œé“¾æ¥
    const unsubscribeToken = Buffer.from(normalizedEmail).toString('base64');
    const unsubscribeLink = `${process.env.NEXT_PUBLIC_SITE_URL}/unsubscribe?token=${unsubscribeToken}`;

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
    const list = await resend.contacts.list({ audienceId: AUDIENCE_ID });
    if (list.data?.data.find((item) => item.email === normalizedEmail)) {
      return NextResponse.json({ success: true, alreadySubscribed: true });
    }

    // å°†ç”¨æˆ·æ·»åŠ åˆ° Resend Audience
    await resend.contacts.create({
      audienceId: AUDIENCE_ID,
      email: normalizedEmail,
      // æ³¨é‡Š: å¯æ·»åŠ æ›´å¤šç”¨æˆ·ä¿¡æ¯
    });

    // å‘é€æ¬¢è¿é‚®ä»¶
    await resend.emails.send({
      from: process.env.ADMIN_EMAIL!,
      to: email,
      subject: 'Welcome to Next Forge',
      html: `
        <h2>Welcome to Next Forge</h2>
        <p>Thank you for subscribing to the newsletter. You will receive the latest updates and news.</p>
        <p style="margin-top: 20px; font-size: 12px; color: #666;">
          If you wish to unsubscribe, please <a href="${unsubscribeLink}">click here</a>
        </p>
      `,
      headers: {
        "List-Unsubscribe": `<${unsubscribeLink}>`,
        "List-Unsubscribe-Post": "List-Unsubscribe=One-Click"
      }
    });

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('é‚®ç®±è®¢é˜…å¤±è´¥:', error);
    return NextResponse.json({ error: 'æœåŠ¡å™¨å¤„ç†è¯·æ±‚å¤±è´¥' }, { status: 500 });
  }
}
```

è¿™ä¸ª API å¯ä»¥æ¥å—é‚®ç®±ï¼Œå¹¶æŠŠé‚®ç®±æ·»åŠ åˆ° Resend çš„ Audience é¢æ¿ï¼Œè¿™æ ·å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ç®¡ç†è®¢é˜…è€…ï¼ŒåŒæ—¶å‘è®¢é˜…è€…å‘é€ä¸€å°è®¢é˜…æˆåŠŸçš„æé†’ã€‚

å› ä¸ºæ ¹æ®é‚®ä»¶è¥é”€æœ€ä½³å®è·µï¼Œæ¯ä¸€å°å‘ç»™è®¢é˜…è€…çš„é‚®ä»¶éƒ½è¦æä¾›é€€è®¢å…¥å£ï¼Œæ‰€ä»¥é‚®ç®±é‡Œå…è®¸ç”¨æˆ·æ‰“å¼€ `unsubscribe` é¡µé¢è¿›è¡Œé€€è®¢ï¼Œæˆ‘ä»¬é€šè¿‡ `Buffer.from(normalizedEmail).toString('base64')` ç”Ÿæˆå½“å‰ç”¨æˆ·æ ‡è¯†ã€‚

### ç”¨æˆ·é€€è®¢é¡µé¢

ç”¨æˆ·é€€è®¢ä¼šæ‰“å¼€ä¸€ä¸ªæºå¸¦å”¯ä¸€æ ‡è¯†çš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªæœåŠ¡ç«¯ç»„ä»¶æ¥æ¥æ”¶å’Œå¤„ç†ï¼š

```tsx
// app/unsubscribe/page.tsx
// å®Œæ•´ä»£ç åœ°å€ï¼šhttps://github.com/weijunext/nextjs-15-starter/blob/main/app/unsubscribe/page.tsx
export default async function UnsubscribePage({ searchParams }: { searchParams: { token?: string } }) {
  let status: "error" | "success" = "error";
  let email = "";
  let errorMessage = "å¤„ç†æ‚¨çš„é€€è®¢è¯·æ±‚æ—¶å‡ºç°é—®é¢˜";

  const token = searchParams.token;

  if (!token) {
    errorMessage = "æœªæä¾›é€€è®¢ä»¤ç‰Œ";
  } else {
    // æ‰§è¡Œé€€è®¢æ“ä½œ
    const result = await unsubscribe(token);
    
    if (result.success) {
      status = "success";
      email = result.email || "";
    } else {
      errorMessage = result.error || "å¤„ç†æ‚¨çš„é€€è®¢è¯·æ±‚æ—¶å‡ºç°é—®é¢˜";
    }
  }

  return (
    <div>
      <h1>é‚®ä»¶è®¢é˜…ç®¡ç†</h1>
      {status === "success" ? (
        <div>
          <p>æ‚¨å·²æˆåŠŸé€€è®¢ã€ŒNext.js ä¸­æ–‡æ–‡æ¡£ã€çš„é‚®ä»¶é€šçŸ¥ã€‚</p>
          <p>é‚®ç®±: {email}</p>
        </div>
      ) : (
        <div>
          <p>{errorMessage}</p>
          <p>è¯·ç¡®ä¿æ‚¨ä½¿ç”¨äº†æ­£ç¡®çš„é€€è®¢é“¾æ¥ã€‚</p>
        </div>
      )}
    </div>
  );
}
```

## æ€»ç»“

ä»¥ä¸Šå³å¯å®Œæˆä¸€ä¸ª newsletter åŠŸèƒ½ï¼Œä½ å¯ä»¥åˆ° [nextforge.dev](https://nextforge.dev) ä½“éªŒã€‚

æ–‡ç« å¼€å¤´è¯´åˆ°ï¼Œæœ¬æ–‡æ˜¯æ¥å…¥åŸºç¡€ï¼Œæ‰€ä»¥å¦‚æœä½ çš„äº§å“ç”¨æˆ·é‡æ¯”è¾ƒå¤§ã€ä¸šåŠ¡é€»è¾‘å¤æ‚ã€å®‰å…¨è¦æ±‚é«˜ï¼Œä½ å¿…é¡»åœ¨åŸºç¡€åŠŸèƒ½ä»¥ä¸Šï¼Œè‡ªä¸»æ·»åŠ æ›´å¤šå®‰å…¨æªæ–½ï¼Œä¾‹å¦‚åˆ©ç”¨ upstash redis çš„ limiter é˜²æ­¢æ¶æ„é‡å¤æäº¤ã€å¼€å¯æœºå™¨äººè¯†åˆ«ã€ä¸­é—´ä»¶å¯¹è¯·æ±‚è¿›è¡Œå®‰å…¨è¿‡æ»¤ç­‰ç­‰å¤šç§æªæ–½ã€‚

## å…³äºæˆ‘

ğŸ§‘â€ğŸ’»ç‹¬ç«‹å¼€å‘ï½œâ›µï¸å‡ºæµ·ï½œNext.jsæ‰‹è‰ºäºº

ğŸ–¥ï¸åšè¿‡å¼€æºï¼šhttp://github.com/weijunext  
âŒ¨ï¸å†™è¿‡åšå®¢ï¼šhttps://weijunext.com  
ğŸ› ï¸ä»Šå¹´æƒ³åšç‹¬ç«‹äº§å“å’Œè¯¾ç¨‹  
ğŸ“˜Nextjsä¸­æ–‡æ–‡æ¡£ï¼šhttp://nextjscn.org  
ğŸ“™å…¨æ ˆå¼€å‘æ•™ç¨‹ï¼šhttps://ship.weijunext.com  

æ¬¢è¿åœ¨ä»¥ä¸‹å¹³å°å…³æ³¨æˆ‘ï¼š

- Twitter: [@weijunext](https://x.com/weijunext)
- Github: [Github](https://github.com/weijunext)
- Blog: [Jå®éªŒå®¤](https://weijunext.com/)
- å³åˆ»: [BigYeç¨‹æ™®](https://m.okjike.com/users/13EF1128-B51B-4D22-8B95-16BB406529F0)
- å¾®ä¿¡äº¤æµç¾¤: [å…¨æ ˆäº¤æµç¾¤](/make-a-friend)

